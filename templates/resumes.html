{% extends "base.html" %}

{% block title %}Resume Management - AI-Powered ATS{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-file-alt me-2"></i>Resume Management</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
        <i class="fas fa-plus me-2"></i>Upload Resume
    </button>
</div>

<!-- Resumes List -->
<div class="row" id="resumesList">
    <div class="col-12 text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading resumes...</p>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Resume</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="resumeFile" class="form-label">Select Resume File</label>
                        <input type="file" class="form-control" id="resumeFile" accept=".pdf,.docx" required>
                        <div class="form-text">Supported formats: PDF, DOCX (Max size: 16MB)</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="replaceExisting">
                            <label class="form-check-label" for="replaceExisting">
                                Replace existing resume if same filename
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="uploadBtn">
                    <i class="fas fa-upload me-2"></i>Upload & Parse
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Resume Detail Modal -->
<div class="modal fade" id="resumeDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-white border-0 shadow-sm">
                <h5 class="modal-title fw-bold text-dark">
                    <i class="fas fa-file-alt me-2 text-primary"></i>Resume Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4" id="resumeDetailContent" style="max-height: 80vh; overflow-y: auto;">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer bg-light border-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Close
                </button>
                <button type="button" class="btn btn-danger" id="deleteResumeBtn">
                    <i class="fas fa-trash me-2"></i>Delete Resume
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="deleteConfirmContent">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-2"></i>Delete Resume & Applications
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
/* Enhanced Resume Details Styling with Better Colors & UX */
.modal-xl {
    max-width: 95vw !important;
}

.modal-dialog-scrollable .modal-body {
    max-height: calc(100vh - 200px);
}

.avatar-circle {
    width: 90px;
    height: 90px;
    border-radius: 50%;
    font-size: 2.8rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.feature-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
    transition: all 0.3s ease;
}

.feature-icon:hover {
    transform: scale(1.05);
}

.skills-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    max-height: 300px;
    overflow-y: auto;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 12px;
}

.skill-tag {
    background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
    color: white;
    padding: 8px 16px;
    border-radius: 25px;
    font-size: 0.9rem;
    font-weight: 600;
    box-shadow: 0 3px 10px rgba(108, 92, 231, 0.3);
    transition: all 0.3s ease;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.skill-tag:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(108, 92, 231, 0.4);
    background: linear-gradient(135deg, #5f4db0 0%, #9188f2 100%);
}

.skill-tag::before {
    content: "‚ö°";
    font-size: 0.8rem;
}

.timeline {
    position: relative;
    padding-left: 35px;
}

.timeline-item {
    position: relative;
    margin-bottom: 30px;
    opacity: 0;
    animation: slideInTimeline 0.6s ease forwards;
}

.timeline-item:nth-child(1) { animation-delay: 0.1s; }
.timeline-item:nth-child(2) { animation-delay: 0.2s; }
.timeline-item:nth-child(3) { animation-delay: 0.3s; }

@keyframes slideInTimeline {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
}

.timeline-item:not(:last-child)::before {
    content: '';
    position: absolute;
    left: -26px;
    top: 30px;
    width: 3px;
    height: calc(100% + 20px);
    background: linear-gradient(to bottom, #74b9ff, #0984e3);
    border-radius: 2px;
}

.timeline-marker {
    position: absolute;
    left: -35px;
    top: 10px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 4px solid #fff;
    box-shadow: 0 0 0 3px #74b9ff, 0 4px 10px rgba(0,0,0,0.1);
    z-index: 2;
}

.timeline-content {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    border: 1px solid rgba(116, 185, 255, 0.2);
    transition: all 0.3s ease;
}

.timeline-content:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.experience-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border-left: 4px solid #74b9ff;
    transition: all 0.3s ease;
}

.experience-card:hover {
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    border-left-color: #0984e3;
}

.education-item {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    border: 2px solid #74b9ff;
    box-shadow: 0 4px 15px rgba(116, 185, 255, 0.1);
    transition: all 0.3s ease;
}

.education-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(116, 185, 255, 0.2);
    border-color: #0984e3;
}

.certification-badge {
    background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
    color: white;
    padding: 10px 18px;
    border-radius: 25px;
    font-size: 0.9rem;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(253, 203, 110, 0.3);
    display: inline-block;
    margin: 4px;
    transition: all 0.3s ease;
}

.certification-badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(253, 203, 110, 0.4);
}

.certification-badge::before {
    content: "üèÜ ";
    margin-right: 5px;
}

.language-badge {
    background: linear-gradient(135deg, #00cec9 0%, #00b894 100%);
    color: white;
    padding: 10px 18px;
    border-radius: 25px;
    font-size: 0.9rem;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0, 206, 201, 0.3);
    display: inline-block;
    margin: 4px;
    transition: all 0.3s ease;
}

.language-badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(0, 206, 201, 0.4);
}

.language-badge::before {
    content: "üåç ";
    margin-right: 5px;
}

.summary-quote {
    position: relative;
    border-left: 6px solid #6c5ce7;
    font-size: 1.1rem;
    line-height: 1.7;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border-radius: 0 12px 12px 0;
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #6c5ce7 0%, #74b9ff 100%) !important;
}

.card {
    transition: all 0.3s ease;
    border: none !important;
}

.card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15) !important;
}

.card-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
    border-radius: 12px 12px 0 0 !important;
    border-bottom: 2px solid #dee2e6 !important;
}

/* Stats card with animation */
.stats-card {
    background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
    color: white;
    text-align: center;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 6px 20px rgba(116, 185, 255, 0.3);
}

.stats-number {
    font-size: 3rem;
    font-weight: 700;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    animation: countUp 1s ease-out;
}

@keyframes countUp {
    from { opacity: 0; transform: scale(0.5); }
    to { opacity: 1; transform: scale(1); }
}

/* Section headers with better styling */
.section-header {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 0;
    color: #2d3436;
    display: flex;
    align-items: center;
    gap: 10px;
}

.section-header i {
    font-size: 1.1rem;
    width: 20px;
    text-align: center;
}

/* Contact info styling */
.contact-info {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-top: 10px;
}

.contact-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 12px;
    background: rgba(255,255,255,0.2);
    border-radius: 20px;
    font-size: 0.95rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .modal-xl { max-width: 98vw !important; }
    .avatar-circle { width: 70px; height: 70px; font-size: 2rem; }
    .timeline { padding-left: 25px; }
    .timeline-marker { left: -25px; width: 16px; height: 16px; }
    .timeline-item:not(:last-child)::before { left: -21px; }
    .contact-info { flex-direction: column; gap: 10px; }
    .skills-grid { max-height: 200px; }
}

/* Smooth scrollbar */
.modal-body::-webkit-scrollbar {
    width: 8px;
}

.modal-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.modal-body::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #6c5ce7, #74b9ff);
    border-radius: 4px;
}

.modal-body::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #5f4db0, #0984e3);
}
</style>
<script>
let currentResumeId = null;

// Utility function to safely escape HTML
function escapeHtml(text) {
    if (text == null || text === undefined) return '';
    return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

// Utility function to safely handle arrays
function safeArray(data, emptyMessage = 'None available') {
    if (!data) return [emptyMessage];
    if (Array.isArray(data)) return data.length > 0 ? data : [emptyMessage];
    if (typeof data === 'string') {
        try {
            const parsed = JSON.parse(data);
            return Array.isArray(parsed) ? (parsed.length > 0 ? parsed : [emptyMessage]) : [data];
        } catch {
            return data.split(',').map(s => s.trim()).filter(s => s.length > 0) || [emptyMessage];
        }
    }
    return [emptyMessage];
}

document.addEventListener('DOMContentLoaded', function() {
    // Add debug logging
    console.log('Resumes page loaded');
    console.log('Token exists:', !!localStorage.getItem('token'));
    console.log('User data:', localStorage.getItem('user'));
    
    // Add global error handler for this page
    window.addEventListener('error', function(event) {
        console.error('JavaScript error on resumes page:', event.error);
        const container = document.getElementById('resumesList');
        if (container && container.innerHTML.includes('Loading resumes')) {
            container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                    <h4>JavaScript Error</h4>
                    <p class="text-muted mb-4">There was an error loading the page. Please refresh and try again.</p>
                    <button class="btn btn-primary" onclick="window.location.reload()">
                        <i class="fas fa-refresh me-2"></i>Refresh Page
                    </button>
                </div>
            `;
        }
    });
    
    loadResumes();
    setupEventListeners();
});

function setupEventListeners() {
    // Upload button
    document.getElementById('uploadBtn').addEventListener('click', uploadResume);
    
    // Delete button
    document.getElementById('deleteResumeBtn').addEventListener('click', deleteResume);
}

async function loadResumes() {
    const token = localStorage.getItem('token');
    
    // Check if token exists
    if (!token) {
        console.log('No authentication token found');
        document.getElementById('resumesList').innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="fas fa-sign-in-alt fa-3x text-primary mb-3"></i>
                <h4>Authentication Required</h4>
                <p class="text-muted mb-4">Please log in to view and manage your resumes</p>
                <div class="d-flex justify-content-center gap-3">
                    <button class="btn btn-primary" onclick="window.location.href='/api/auth/github/login'">
                        <i class="fab fa-github me-2"></i>Login with GitHub
                    </button>
                    <button class="btn btn-outline-primary" onclick="window.location.href='/'">
                        <i class="fas fa-home me-2"></i>Go Home
                    </button>
                </div>
            </div>
        `;
        return;
    }
    
    try {
        const response = await fetch('/api/resumes/list', {
            headers: { 
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        if (response.ok) {
            const data = await response.json();
            console.log('Resume data:', data);
            displayResumes(data.resumes || []);
        } else {
            const errorData = await response.json().catch(() => ({}));
            console.error('API Error:', response.status, errorData);
            
            if (response.status === 401) {
                // Token is invalid, redirect to login
                console.log('Authentication failed - clearing token');
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                document.getElementById('resumesList').innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-clock fa-3x text-warning mb-3"></i>
                        <h4>Session Expired</h4>
                        <p class="text-muted mb-4">Your session has expired. Please log in again to continue.</p>
                        <div class="d-flex justify-content-center gap-3">
                            <button class="btn btn-primary" onclick="window.location.href='/api/auth/github/login'">
                                <i class="fab fa-github me-2"></i>Login Again
                            </button>
                            <button class="btn btn-outline-primary" onclick="window.location.href='/'">
                                <i class="fas fa-home me-2"></i>Go Home
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            throw new Error(errorData.error || `HTTP ${response.status}: Failed to load resumes`);
        }
    } catch (error) {
        console.error('Error loading resumes:', error);
        document.getElementById('resumesList').innerHTML = `
            <div class="col-12 text-center">
                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                <p>Error loading resumes: ${error.message}</p>
                <button class="btn btn-primary" onclick="loadResumes()">Retry</button>
            </div>
        `;
    }
}

function displayResumes(resumes) {
    const container = document.getElementById('resumesList');
    
    console.log('Displaying resumes:', resumes);
    console.log('Number of resumes:', resumes ? resumes.length : 'undefined');
    
    if (!resumes || resumes.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                <h4>No Resumes Yet</h4>
                <p class="text-muted">Upload your first resume to get started with AI-powered parsing</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    <i class="fas fa-plus me-2"></i>Upload Resume
                </button>
            </div>
        `;
        return;
    }
    
    // Helper function to safely get skills array
    const getSkillsArray = (skills) => {
        if (!skills) return [];
        if (Array.isArray(skills)) return skills;
        if (typeof skills === 'string') {
            try {
                // Try to parse as JSON array
                const parsed = JSON.parse(skills);
                return Array.isArray(parsed) ? parsed : [skills];
            } catch {
                // If not JSON, treat as comma-separated string
                return skills.split(',').map(s => s.trim()).filter(s => s.length > 0);
            }
        }
        return [];
    };
    
    container.innerHTML = resumes.map(resume => {
        const skillsArray = getSkillsArray(resume.skills);
        const displaySkills = skillsArray.slice(0, 3);
        const remainingCount = Math.max(0, skillsArray.length - 3);
        
        return `
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100 shadow-sm resume-card">
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h5 class="card-title text-truncate" style="max-width: 70%;" title="${(resume.filename || 'Untitled').replace(/"/g, '&quot;')}">${(resume.filename || 'Untitled').replace(/"/g, '&quot;')}</h5>
                        <span class="badge bg-success">Parsed</span>
                    </div>
                    
                    <div class="contact-info mb-3 flex-shrink-0">
                        <p class="mb-1"><strong>Name:</strong> <span class="text-break-word">${(resume.name || 'Not extracted').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span></p>
                        <p class="mb-1"><strong>Email:</strong> <span class="text-break-word">${(resume.email || 'Not extracted').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span></p>
                        <p class="mb-1"><strong>Phone:</strong> ${(resume.phone || 'Not extracted').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>
                    </div>
                    
                    <div class="mb-3 flex-grow-1">
                        <p class="mb-1"><strong>Skills:</strong></p>
                        <div class="skills-container">
                            ${displaySkills.map(skill => 
                                `<span class="badge bg-light text-dark" title="${String(skill).replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}">${String(skill).replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span>`
                            ).join('')}
                            ${remainingCount > 0 ? 
                                `<span class="badge bg-secondary">+${remainingCount} more</span>` : ''}
                            ${skillsArray.length === 0 ? 
                                '<span class="text-muted">No skills extracted</span>' : ''}
                        </div>
                    </div>
                    
                    <div class="mt-auto">
                        <div class="mb-2">
                            <small class="text-muted">
                                Uploaded: ${resume.created_at ? new Date(resume.created_at).toLocaleDateString() : 'Unknown'}
                            </small>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-transparent">
                    <div class="btn-group w-100">
                        <button class="btn btn-outline-primary btn-sm" onclick="viewResumeFile(${resume.id})" title="View Resume File">
                            <i class="fas fa-eye me-1"></i>View Resume
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="getResumeInsights(${resume.id})" title="AI Resume Insights">
                            <i class="fas fa-brain me-1"></i>AI Insights
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="confirmDeleteResume(${resume.id}, '${(resume.filename || '').replace(/'/g, '\\\'').replace(/"/g, '&quot;')}')" title="Delete Resume">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `; // End of template string
    }).join(''); // End of map function
}

async function uploadResume() {
    const fileInput = document.getElementById('resumeFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showAlert('Please select a file', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    const token = localStorage.getItem('token');
    const uploadBtn = document.getElementById('uploadBtn');
    
    try {
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';
        uploadBtn.disabled = true;
        
        const response = await fetch('/api/resumes/upload', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showAlert('Resume uploaded and parsed successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
            loadResumes();
            document.getElementById('uploadForm').reset();
        } else {
            showAlert(data.error || 'Upload failed', 'danger');
        }
    } catch (error) {
        showAlert('Network error. Please try again.', 'danger');
    } finally {
        uploadBtn.innerHTML = '<i class="fas fa-upload me-2"></i>Upload & Parse';
        uploadBtn.disabled = false;
    }
}

async function viewResumeDetails(resumeId) {
    const token = localStorage.getItem('token');
    
    try {
        const response = await fetch(`/api/resumes/${resumeId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const data = await response.json();
            displayResumeDetails(data.resume);
            currentResumeId = resumeId;
            new bootstrap.Modal(document.getElementById('resumeDetailModal')).show();
        } else {
            showAlert('Failed to load resume details', 'danger');
        }
    } catch (error) {
        showAlert('Network error', 'danger');
    }
}

function viewResumeFile(resumeId) {
    // Use the existing viewResumeDetails function to show parsed resume data
    viewResumeDetails(resumeId);
}

function displayResumeDetails(resume) {
    const content = document.getElementById('resumeDetailContent');
    const parsedData = resume.parsed_data || {};
    
    // Helper function to safely get nested properties
    const safeGet = (obj, path, fallback = 'N/A') => {
        const result = path.split('.').reduce((o, p) => (o && o[p]) ? o[p] : fallback, obj);
        return escapeHtml(result);
    };
    
    // Helper function to display array data
    const displayArray = (arr, emptyMessage = 'None available') => {
        return (arr && arr.length > 0) ? arr : [emptyMessage];
    };
    
    content.innerHTML = `
        <!-- Resume Overview Card (matching AI insights style) -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="fas fa-file-alt me-2"></i>Resume Overview</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h4 class="mb-2 fw-bold">${safeGet(parsedData, 'personal_info.name') || resume.name || resume.filename}</h4>
                        <div class="row g-3">
                            ${parsedData.personal_info?.email ? `
                            <div class="col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-envelope text-primary me-2"></i>
                                    <span>${parsedData.personal_info.email}</span>
                                </div>
                            </div>` : ''}
                            ${parsedData.personal_info?.phone ? `
                            <div class="col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-phone text-primary me-2"></i>
                                    <span>${parsedData.personal_info.phone}</span>
                                </div>
                            </div>` : ''}
                            ${parsedData.personal_info?.location ? `
                            <div class="col-sm-6">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-map-marker-alt text-primary me-2"></i>
                                    <span>${parsedData.personal_info.location}</span>
                                </div>
                            </div>` : ''}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="row g-3 text-center">
                            <div class="col-4">
                                <div class="display-4 text-primary">
                                    ${(() => {
                                        const skillsData = parsedData.skills || resume.skills || [];
                                        const skillsArray = Array.isArray(skillsData) ? skillsData : 
                                                          typeof skillsData === 'string' ? 
                                                          (skillsData.includes(',') ? skillsData.split(',').map(s => s.trim()) : [skillsData]) : 
                                                          [];
                                        return skillsArray.length;
                                    })()}
                                </div>
                                <small class="text-muted">Skills</small>
                            </div>
                            <div class="col-4">
                                <div class="h4 text-info">
                                    ${displayArray(parsedData.experience || resume.experience).length}
                                </div>
                                <small class="text-muted">Positions</small>
                            </div>
                            <div class="col-4">
                                <div class="h5 text-success">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <small class="text-muted">Parsed</small>
                            </div>
                        </div>
                    </div>
                </div>
                ${parsedData.personal_info?.name ? `
                <hr>
                <div class="alert alert-light">
                    <h6><i class="fas fa-info-circle me-2"></i>Quick Summary</h6>
                    <p class="mb-0">Resume contains ${Object.keys(parsedData).length} data sections with contact information and professional background.</p>
                </div>
                ` : ''}
            </div>
        </div>

        ${parsedData.summary ? `
        <!-- Professional Summary Card -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="fas fa-quote-left me-2"></i>Professional Summary</h6>
            </div>
            <div class="card-body">
                <div class="alert alert-light">
                    <h6><i class="fas fa-lightbulb me-2"></i>Career Overview</h6>
                    <p class="mb-0 fst-italic">${parsedData.summary}</p>
                </div>
            </div>
        </div>
        ` : ''}
        
        <!-- Technical Skills Card -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="fas fa-cogs me-2"></i>Technical Skills & Expertise</h6>
            </div>
            <div class="card-body">
                ${(() => {
                    const skillsData = parsedData.skills || resume.skills || [];
                    const skillsArray = Array.isArray(skillsData) ? skillsData : 
                                      typeof skillsData === 'string' ? 
                                      (skillsData.includes(',') ? skillsData.split(',').map(s => s.trim()) : [skillsData]) : 
                                      [];
                    
                    if (skillsArray.length === 0) {
                        return '<div class="text-center text-muted py-4"><i class="fas fa-info-circle me-2"></i>No skills extracted from resume</div>';
                    }
                    
                    return `
                        <div class="row">
                            ${skillsArray.map(skill => 
                                `<div class="col-md-3 col-sm-4 col-6 mb-3">
                                    <div class="border rounded p-3 text-center">
                                        <span class="badge bg-primary w-100 p-2">${String(skill).replace(/"/g, '&quot;')}</span>
                                    </div>
                                </div>`
                            ).join('')}
                        </div>
                        <div class="alert alert-light mt-3">
                            <h6><i class="fas fa-lightbulb me-2"></i>Skills Summary</h6>
                            <p class="mb-0">Total ${skillsArray.length} skills identified from resume content and categorized for technical assessment.</p>
                        </div>
                    `;
                })()}
            </div>
        </div>
        
        <!-- Professional Experience Card -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0"><i class="fas fa-briefcase me-2"></i>Professional Experience</h6>
            </div>
            <div class="card-body">
                <div class="accordion" id="experienceAccordion">
                    ${displayArray(parsedData.experience || resume.experience).map((exp, index) => 
                        typeof exp === 'string' ? 
                        `<div class="border rounded p-3 mb-3">
                            <p class="text-muted mb-0">${exp}</p>
                        </div>` :
                        `<div class="accordion-item">
                            <h2 class="accordion-header" id="exp${index}">
                                <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#expCollapse${index}">
                                    <div class="d-flex justify-content-between w-100 me-3">
                                        <span><strong>${exp.position || exp.title || 'Position not specified'}</strong> at ${exp.company || 'Company not specified'}</span>
                                        <span class="badge bg-secondary">${exp.duration || 'Duration not specified'}</span>
                                    </div>
                                </button>
                            </h2>
                            <div id="expCollapse${index}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" data-bs-parent="#experienceAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <strong>Position:</strong> ${exp.position || exp.title || 'Not specified'}<br>
                                            <strong>Company:</strong> ${exp.company || 'Not specified'}<br>
                                            <strong>Duration:</strong> ${exp.duration || 'Not specified'}
                                        </div>
                                        <div class="col-md-4">
                                            <div class="text-center p-2 border rounded">
                                                <div class="small"><strong>Experience Level</strong></div>
                                                <div class="text-muted small">Professional</div>
                                            </div>
                                        </div>
                                    </div>
                                    ${exp.description ? `
                                    <hr>
                                    <div class="alert alert-light">
                                        <h6><i class="fas fa-info-circle me-2"></i>Role Description</h6>
                                        <p class="mb-0">${exp.description}</p>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>`
                    ).join('')}
                </div>
            </div>
        </div>
        
        <!-- Educational Background Card -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0"><i class="fas fa-graduation-cap me-2"></i>Educational Background</h6>
            </div>
            <div class="card-body">
                ${(() => {
                    const educationData = displayArray(parsedData.education || resume.education);
                    
                    if (educationData.length === 1 && educationData[0] === 'None available') {
                        return '<div class="text-center text-muted py-4"><i class="fas fa-info-circle me-2"></i>No education information extracted from resume</div>';
                    }
                    
                    return `
                        <div class="row">
                            ${educationData.map((edu, index) => 
                                typeof edu === 'string' ? 
                                `<div class="col-12 mb-3">
                                    <div class="border rounded p-3">
                                        <div class="alert alert-light mb-0">
                                            <i class="fas fa-school me-2"></i>${edu}
                                        </div>
                                    </div>
                                </div>` :
                                `<div class="col-md-6 mb-3">
                                    <div class="border rounded p-3">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="mb-0">${edu.degree || 'Degree not specified'}</h6>
                                            <span class="badge bg-primary">${edu.graduation_year || 'Year N/A'}</span>
                                        </div>
                                        <div class="small mb-2">
                                            <strong>Institution:</strong> ${edu.institution || 'Not specified'}
                                        </div>
                                        ${edu.gpa ? `<div class="small mb-2"><strong>GPA:</strong> ${edu.gpa}</div>` : ''}
                                        ${edu.relevant_coursework && edu.relevant_coursework.length > 0 ? 
                                            `<div class="mt-2">
                                                <small class="text-muted d-block mb-2">Relevant Coursework:</small>
                                                <div class="d-flex flex-wrap gap-1">
                                                    ${edu.relevant_coursework.map(course => 
                                                        `<span class="badge bg-light text-dark border small">${course}</span>`
                                                    ).join('')}
                                                </div>
                                            </div>` : ''}
                                    </div>
                                </div>`
                            ).join('')}
                        </div>
                    `;
                })()}
            </div>
        </div>
        
        <!-- Additional Information Card -->
        ${(parsedData.certifications && parsedData.certifications.length > 0) || (parsedData.languages && parsedData.languages.length > 0) ? `
        <div class="card mb-4">
            <div class="card-header bg-dark text-white">
                <h6 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Additional Information</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    ${parsedData.certifications && parsedData.certifications.length > 0 ? `
                    <div class="col-md-6 mb-4">
                        <h6><i class="fas fa-certificate me-2"></i>Certifications</h6>
                        <div class="row">
                            ${parsedData.certifications.map(cert => 
                                `<div class="col-sm-6 mb-3">
                                    <div class="border rounded p-3 text-center">
                                        <div class="badge bg-success w-100 p-2">${cert}</div>
                                    </div>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${parsedData.languages && parsedData.languages.length > 0 ? `
                    <div class="col-md-6 mb-4">
                        <h6><i class="fas fa-globe me-2"></i>Languages</h6>
                        <div class="row">
                            ${parsedData.languages.map(lang => 
                                `<div class="col-sm-6 mb-3">
                                    <div class="border rounded p-3 text-center">
                                        <div class="badge bg-info w-100 p-2">${lang}</div>
                                    </div>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
                <div class="alert alert-light">
                    <h6><i class="fas fa-info-circle me-2"></i>Additional Qualifications</h6>
                    <p class="mb-0">Extra credentials and language skills that enhance the candidate's profile and demonstrate professional development.</p>
                </div>
            </div>
        </div>
        ` : ''}
        
        <!-- Analysis Metadata Card -->
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-cogs me-2"></i>Processing Metadata</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <div class="display-6 text-primary">${(resume.raw_text || '').length || 0}</div>
                        <small class="text-muted">Characters</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="h4 text-info">${Object.keys(parsedData).length}</div>
                        <small class="text-muted">Data Sections</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="h5 text-success">${resume.filename.split('.').pop().toUpperCase()}</div>
                        <small class="text-muted">File Type</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="h6 text-secondary">${new Date(resume.created_at).toLocaleDateString()}</div>
                        <small class="text-muted">Upload Date</small>
                    </div>
                </div>
                <hr>
                <div class="alert alert-light">
                    <h6><i class="fas fa-info-circle me-2"></i>Processing Summary</h6>
                    <p class="mb-0">Resume "${resume.filename}" was successfully parsed and processed, extracting structured data from ${(resume.raw_text || '').length} characters of content.</p>
                </div>
            </div>
        </div>
    `;
}

function confirmDeleteResume(resumeId, filename) {
    // Try to delete normally first, the backend will handle conflicts
    deleteResumeById(resumeId);
}

async function deleteResume() {
    if (currentResumeId) {
        await deleteResumeById(currentResumeId);
        bootstrap.Modal.getInstance(document.getElementById('resumeDetailModal')).hide();
    }
}

async function deleteResumeById(resumeId, forceDelete = false) {
    const token = localStorage.getItem('token');
    
    try {
        const url = forceDelete ? `/api/resumes/${resumeId}?force=true` : `/api/resumes/${resumeId}`;
        const response = await fetch(url, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const data = await response.json();
            showAlert(data.message || 'Resume deleted successfully', 'success');
            loadResumes();
        } else if (response.status === 409) {
            // Resume is used in applications - show detailed confirmation
            const data = await response.json();
            handleResumeInUseError(resumeId, data);
        } else {
            const data = await response.json();
            showAlert(data.error || 'Failed to delete resume', 'danger');
        }
    } catch (error) {
        showAlert('Network error', 'danger');
    }
}

function handleResumeInUseError(resumeId, errorData) {
    const applicationsCount = errorData.applications_count;
    const applications = errorData.applications || [];
    
    // Create detailed content for the modal
    let content = `
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Warning:</strong> This resume is currently used in ${applicationsCount} job application(s).
        </div>
        <p>Deleting this resume will also delete the following applications:</p>
        <div class="list-group mb-3">
    `;
    
    applications.forEach((app, index) => {
        const appliedDate = app.applied_at ? new Date(app.applied_at).toLocaleDateString() : 'Unknown date';
        content += `
            <div class="list-group-item">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${app.job_title}</h6>
                    <small>${appliedDate}</small>
                </div>
                <p class="mb-1">${app.company}</p>
                <small>Status: <span class="badge bg-secondary">${app.status}</span></small>
            </div>
        `;
    });
    
    content += `
        </div>
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong>This action cannot be undone!</strong> Are you sure you want to proceed?
        </div>
    `;
    
    // Set modal content
    document.getElementById('deleteConfirmContent').innerHTML = content;
    
    // Set up the confirm button
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    confirmBtn.onclick = () => {
        bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
        deleteResumeById(resumeId, true); // Force delete
    };
    
    // Show the modal
    new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
}

// Resume Insights functionality (same as in candidate dashboard)
async function getResumeInsights(resumeId) {
    try {
        // Show loading indicator
        showAlert('Generating AI insights for your resume...', 'info', 0);
        
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/resumes/${resumeId}/insights`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        // Remove loading alert
        const alertContainer = document.getElementById('alertContainer');
        if (alertContainer) {
            alertContainer.innerHTML = '';
        }
        
        if (data.success) {
            displayInsightsModal(data.insights);
        } else {
            showAlert(data.error || 'Failed to generate insights', 'danger');
        }
        
    } catch (error) {
        console.error('Error fetching resume insights:', error);
        showAlert('Failed to generate insights. Please try again.', 'danger');
    }
}

function displayInsightsModal(insights) {
    // Create modal HTML (reuse the same modal from candidate dashboard)
    const modalHtml = `
        <div class="modal fade" id="insightsModal" tabindex="-1" aria-labelledby="insightsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="insightsModalLabel">
                            <i class="fas fa-brain me-2"></i>AI Resume Insights
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        ${generateInsightsHTML(insights)}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="downloadInsightsReport(${JSON.stringify(insights).replace(/"/g, '&quot;')})">
                            <i class="fas fa-download me-1"></i>Download Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('insightsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('insightsModal'));
    modal.show();
}

// Helper functions for insights display
function generateInsightsHTML(insights) {
    let html = '';
    
    console.log('Insights data:', insights); // Debug log
    
    // Handle both old and new format
    const llmAnalysis = insights.llm_analysis || insights;
    
    // Executive Summary
    if (llmAnalysis.executive_summary) {
        html += `
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Executive Summary</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <div class="display-4 text-primary">${llmAnalysis.executive_summary.overall_score || 'N/A'}/10</div>
                            <small class="text-muted">Overall Score</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="h4 text-${getScoreColor(llmAnalysis.executive_summary.technical_level)}">${llmAnalysis.executive_summary.technical_level || 'N/A'}</div>
                            <small class="text-muted">Technical Level</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="h4 text-${getRecommendationColor(llmAnalysis.executive_summary.hire_confidence)}">${llmAnalysis.executive_summary.hire_confidence || 'N/A'}</div>
                            <small class="text-muted">Hire Confidence</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="h5 text-${getRiskColor(llmAnalysis.executive_summary.risk_level)}">${llmAnalysis.executive_summary.risk_level || 'N/A'}</div>
                            <small class="text-muted">Risk Level</small>
                        </div>
                    </div>
                    ${llmAnalysis.executive_summary.summary ? `
                    <hr>
                    <div class="alert alert-light">
                        <h6><i class="fas fa-lightbulb me-2"></i>Key Insights</h6>
                        <p class="mb-0">${escapeHtml(llmAnalysis.executive_summary.summary)}</p>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    // Deep Technical Analysis
    if (llmAnalysis.deep_technical_analysis) {
        const techAnalysis = llmAnalysis.deep_technical_analysis;
        
        html += `
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-code me-2"></i>Deep Technical Analysis</h6>
                </div>
                <div class="card-body">
        `;
        
        // Core Skills Assessment
        if (techAnalysis.core_skills && techAnalysis.core_skills.length > 0) {
            html += `
                <div class="mb-4">
                    <h6><i class="fas fa-cogs me-2"></i>Core Skills Assessment</h6>
                    <div class="row">
            `;
            
            techAnalysis.core_skills.forEach(skill => {
                const verdictClass = getVerdictBadgeClass(skill.verdict);
                const evidenceClass = getEvidenceQualityClass(skill.evidence_quality);
                
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0">${escapeHtml(skill.skill || 'Unknown Skill')}</h6>
                                <span class="badge ${verdictClass}">${skill.verdict || 'N/A'}</span>
                            </div>
                            <div class="small mb-2">
                                <strong>Claimed:</strong> ${escapeHtml(skill.claimed_level || 'N/A')} ‚Üí 
                                <strong>Assessed:</strong> ${escapeHtml(skill.assessed_level || 'N/A')}
                            </div>
                            <div class="mb-2">
                                <span class="badge ${evidenceClass} small">${skill.evidence_quality || 'N/A'} Evidence</span>
                            </div>
                            ${skill.depth_indicators && skill.depth_indicators.length > 0 ? `
                            <div class="small text-success mb-1">
                                <strong>Evidence:</strong> ${skill.depth_indicators.join(', ')}
                            </div>
                            ` : ''}
                            ${skill.red_flags && skill.red_flags.length > 0 ? `
                            <div class="small text-danger">
                                <strong>Red Flags:</strong> ${skill.red_flags.join(', ')}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += `</div></div>`;
        }
        
        // Architecture Understanding
        if (techAnalysis.architecture_understanding) {
            const arch = techAnalysis.architecture_understanding;
            html += `
                <div class="mb-4">
                    <h6><i class="fas fa-sitemap me-2"></i>Architecture Understanding</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="border rounded p-3">
                                <strong>System Design:</strong> ${escapeHtml(arch.system_design || 'N/A')}<br>
                                <strong>Scalability Awareness:</strong> ${escapeHtml(arch.scalability_awareness || 'N/A')}<br>
                                <strong>Complexity Handled:</strong> ${escapeHtml(arch.complexity_handled || 'N/A')}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-3">
                                <strong>Architectural Patterns:</strong><br>
                                ${arch.architectural_patterns && arch.architectural_patterns.length > 0 ? 
                                    arch.architectural_patterns.map(pattern => `<span class="badge bg-secondary me-1">${pattern}</span>`).join('') : 
                                    '<span class="text-muted">None identified</span>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Code Quality Indicators
        if (techAnalysis.code_quality_indicators) {
            const quality = techAnalysis.code_quality_indicators;
            html += `
                <div class="mb-3">
                    <h6><i class="fas fa-check-circle me-2"></i>Code Quality Indicators</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center p-2 border rounded">
                                <div class="small"><strong>Testing Practices</strong></div>
                                <div class="text-muted small">${escapeHtml(quality.testing_practices || 'N/A')}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-2 border rounded">
                                <div class="small"><strong>Documentation</strong></div>
                                <div class="text-muted small">${escapeHtml(quality.documentation_habits || 'N/A')}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-2 border rounded">
                                <div class="small"><strong>Code Review</strong></div>
                                <div class="text-muted small">${escapeHtml(quality.code_review_experience || 'N/A')}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-2 border rounded">
                                <div class="small"><strong>Tech Debt Awareness</strong></div>
                                <div class="text-muted small">${escapeHtml(quality.technical_debt_awareness || 'N/A')}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        html += `</div></div>`;
    }
    
    // Experience Scrutiny
    if (llmAnalysis.experience_scrutiny) {
        const exp = llmAnalysis.experience_scrutiny;
        
        html += `
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="fas fa-briefcase me-2"></i>Experience Scrutiny</h6>
                </div>
                <div class="card-body">
        `;
        
        // Career Velocity
        if (exp.career_velocity) {
            const velocity = exp.career_velocity;
            html += `
                <div class="mb-4">
                    <h6><i class="fas fa-trending-up me-2"></i>Career Velocity</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="border rounded p-3">
                                <strong>Progression Rate:</strong> ${escapeHtml(velocity.progression_rate || 'N/A')}<br>
                                <strong>Responsibility Growth:</strong> ${escapeHtml(velocity.responsibility_growth || 'N/A')}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-3">
                                <strong>Technical Growth:</strong> ${escapeHtml(velocity.technical_growth || 'N/A')}<br>
                                <strong>Leadership Trajectory:</strong> ${escapeHtml(velocity.leadership_trajectory || 'N/A')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Project Analysis
        if (exp.project_analysis && exp.project_analysis.length > 0) {
            html += `
                <div class="mb-4">
                    <h6><i class="fas fa-project-diagram me-2"></i>Project Analysis</h6>
                    <div class="accordion" id="projectAccordion">
            `;
            
            exp.project_analysis.forEach((project, index) => {
                const credibilityClass = getCredibilityScoreClass(project.credibility_score);
                html += `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="project${index}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#projectCollapse${index}">
                                <div class="d-flex justify-content-between w-100 me-3">
                                    <span>${escapeHtml(project.project || `Project ${index + 1}`)}</span>
                                    <span class="badge ${credibilityClass}">${project.credibility_score || 'N/A'}/10</span>
                                </div>
                            </button>
                        </h2>
                        <div id="projectCollapse${index}" class="accordion-collapse collapse" data-bs-parent="#projectAccordion">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Complexity:</strong> ${escapeHtml(project.complexity_assessment || 'N/A')}<br>
                                        <strong>Technical Challenges:</strong> ${escapeHtml(project.technical_challenges || 'N/A')}<br>
                                        <strong>Impact:</strong> ${escapeHtml(project.impact_verification || 'N/A')}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Role Clarity:</strong> ${escapeHtml(project.role_clarity || 'N/A')}<br>
                                        <strong>Buzzword Ratio:</strong> ${escapeHtml(project.buzzword_ratio || 'N/A')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div></div>`;
        }
        
        // Employment Red Flags
        if (exp.employment_red_flags && exp.employment_red_flags.length > 0) {
            html += `
                <div class="mb-3">
                    <h6><i class="fas fa-exclamation-triangle me-2 text-danger"></i>Red Flags</h6>
            `;
            
            exp.employment_red_flags.forEach(flag => {
                const severityClass = getSeverityBadgeClass(flag.severity);
                html += `
                    <div class="alert alert-light border-start border-danger border-3 mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${escapeHtml(flag.flag || 'Unknown Flag')}</strong>
                                <span class="badge ${severityClass} ms-2">${flag.severity || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="small text-muted mt-1">${escapeHtml(flag.explanation || 'N/A')}</div>
                        ${flag.potential_mitigations ? `
                        <div class="small text-success mt-1">
                            <strong>Potential Mitigations:</strong> ${escapeHtml(flag.potential_mitigations)}
                        </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += `</div>`;
        }
        
        html += `</div></div>`;
    }
    
    // Hiring Recommendation
    if (llmAnalysis.hiring_recommendation) {
        const hiring = llmAnalysis.hiring_recommendation;
        html += `
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fas fa-user-check me-2"></i>Hiring Recommendation</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <div class="h3 text-${getRecommendationColor(hiring.decision)}">${hiring.decision || 'N/A'}</div>
                            <small class="text-muted">Decision</small>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="h4 text-${getConfidenceColor(hiring.confidence)}">${hiring.confidence || 'N/A'}</div>
                            <small class="text-muted">Confidence</small>
                        </div>
                        <div class="col-md-4">
                            ${hiring.interview_priorities && hiring.interview_priorities.length > 0 ? `
                            <div>
                                <strong>Interview Priorities:</strong>
                                <ul class="small mb-0">
                                    ${hiring.interview_priorities.map(priority => `<li>${escapeHtml(priority)}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${hiring.conditions && hiring.conditions.length > 0 ? `
                    <hr>
                    <div class="mb-3">
                        <strong>Conditions:</strong>
                        <ul class="small mb-0">
                            ${hiring.conditions.map(condition => `<li>${escapeHtml(condition)}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    
                    ${hiring.risk_factors && hiring.risk_factors.length > 0 ? `
                    <div class="alert alert-warning">
                        <strong><i class="fas fa-exclamation-triangle me-2"></i>Risk Factors:</strong>
                        <ul class="small mb-0">
                            ${hiring.risk_factors.map(risk => `<li>${escapeHtml(risk)}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    // Development Roadmap
    if (llmAnalysis.development_roadmap) {
        const roadmap = llmAnalysis.development_roadmap;
        html += `
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="fas fa-road me-2"></i>Development Roadmap</h6>
                </div>
                <div class="card-body">
        `;
        
        // Immediate Gaps
        if (roadmap.immediate_gaps && roadmap.immediate_gaps.length > 0) {
            html += `
                <div class="mb-4">
                    <h6><i class="fas fa-gap me-2"></i>Immediate Gaps</h6>
                    <div class="row">
            `;
            
            roadmap.immediate_gaps.forEach(gap => {
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3">
                            <h6 class="text-warning">${escapeHtml(gap.gap || 'Unknown Gap')}</h6>
                            <div class="small mb-2">
                                <strong>Business Impact:</strong> ${escapeHtml(gap.business_impact || 'N/A')}
                            </div>
                            <div class="small mb-2">
                                <strong>Time to Fill:</strong> ${escapeHtml(gap.time_to_fill || 'N/A')}
                            </div>
                            <div class="small">
                                <strong>Training Cost:</strong> ${escapeHtml(gap.training_cost || 'N/A')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div></div>`;
        }
        
        // Growth Potential
        if (roadmap.growth_potential) {
            const growth = roadmap.growth_potential;
            html += `
                <div class="mb-3">
                    <h6><i class="fas fa-chart-line me-2"></i>Growth Potential</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="border rounded p-3">
                                <strong>Trajectory:</strong> ${escapeHtml(growth.trajectory || 'N/A')}<br>
                                <strong>Learning Velocity:</strong> ${escapeHtml(growth.learning_velocity || 'N/A')}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-3">
                                <strong>Adaptability:</strong> ${escapeHtml(growth.adaptability || 'N/A')}<br>
                                <strong>Ceiling:</strong> ${escapeHtml(growth.ceiling || 'N/A')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        html += `</div></div>`;
    }
    
    // Fallback for old format or incomplete data
    if (!html || html.trim() === '') {
        html = `
            <div class="alert alert-info">
                <h6><i class="fas fa-info-circle me-2"></i>Resume Analysis</h6>
                <p class="mb-0">This resume has been analyzed. The detailed insights may be processing or in a different format.</p>
                <hr>
                <pre class="small text-muted">${JSON.stringify(insights, null, 2)}</pre>
            </div>
        `;
    }
    
    return html;
}

function getProficiencyBadgeClass(proficiency) {
    switch (proficiency?.toLowerCase()) {
        case 'expert': return 'bg-success';
        case 'advanced': return 'bg-primary';
        case 'intermediate': return 'bg-warning';
        case 'beginner': return 'bg-secondary';
        default: return 'bg-info';
    }
}

function getScoreColor(level) {
    if (typeof level === 'string') {
        switch (level.toLowerCase()) {
            case 'senior': case 'expert': case 'lead': return 'success';
            case 'mid': case 'intermediate': case 'advanced': return 'primary';
            case 'junior': case 'beginner': return 'warning';
            default: return 'info';
        }
    }
    return 'info';
}

function getRecommendationColor(decision) {
    if (typeof decision === 'string') {
        switch (decision.toLowerCase()) {
            case 'strong yes': case 'yes': case 'high': return 'success';
            case 'maybe': case 'medium': return 'warning';
            case 'no': case 'strong no': case 'low': return 'danger';
            default: return 'info';
        }
    }
    return 'info';
}

function getRiskColor(level) {
    if (typeof level === 'string') {
        switch (level.toLowerCase()) {
            case 'low': return 'success';
            case 'medium': return 'warning';
            case 'high': case 'critical': return 'danger';
            default: return 'info';
        }
    }
    return 'info';
}

function getVerdictBadgeClass(verdict) {
    if (typeof verdict === 'string') {
        switch (verdict.toLowerCase()) {
            case 'expert': return 'bg-success';
            case 'proficient': return 'bg-primary';
            case 'competent': return 'bg-info';
            case 'novice': return 'bg-warning';
            case 'unproven': return 'bg-secondary';
            default: return 'bg-light text-dark';
        }
    }
    return 'bg-light text-dark';
}

function getEvidenceQualityClass(quality) {
    if (typeof quality === 'string') {
        switch (quality.toLowerCase()) {
            case 'strong': return 'bg-success';
            case 'moderate': return 'bg-primary';
            case 'weak': return 'bg-warning';
            case 'no evidence': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }
    return 'bg-secondary';
}

function getCredibilityScoreClass(score) {
    if (typeof score === 'number') {
        if (score >= 8) return 'bg-success';
        if (score >= 6) return 'bg-primary';
        if (score >= 4) return 'bg-warning';
        return 'bg-danger';
    }
    return 'bg-secondary';
}

function getSeverityBadgeClass(severity) {
    if (typeof severity === 'string') {
        switch (severity.toLowerCase()) {
            case 'critical': return 'bg-danger';
            case 'high': return 'bg-warning';
            case 'medium': return 'bg-info';
            case 'low': return 'bg-secondary';
            default: return 'bg-light text-dark';
        }
    }
    return 'bg-light text-dark';
}

function getConfidenceColor(confidence) {
    if (typeof confidence === 'string') {
        switch (confidence.toLowerCase()) {
            case 'high': return 'success';
            case 'medium': return 'warning';
            case 'low': return 'danger';
            default: return 'info';
        }
    }
    return 'info';
}

function downloadInsightsReport(insights) {
    // Create a formatted text report
    let report = "RESUME INSIGHTS REPORT\n";
    report += "=".repeat(50) + "\n\n";
    
    if (insights.technical_assessment) {
        report += "TECHNICAL ASSESSMENT\n";
        report += "-".repeat(20) + "\n";
        report += `Overall Rating: ${insights.technical_assessment.overall_rating}/10\n`;
        report += `Technical Strength: ${insights.technical_assessment.technical_strength}\n`;
        report += `Summary: ${insights.technical_assessment.summary}\n\n`;
    }
    
    if (insights.strengths) {
        report += "KEY STRENGTHS\n";
        report += "-".repeat(20) + "\n";
        insights.strengths.forEach((strength, index) => {
            report += `${index + 1}. ${strength.strength}\n`;
            report += `   Evidence: ${strength.evidence}\n`;
            report += `   Market Value: ${strength.market_value}\n\n`;
        });
    }
    
    if (insights.recommendations && insights.recommendations.immediate_improvements) {
        report += "RECOMMENDATIONS\n";
        report += "-".repeat(20) + "\n";
        insights.recommendations.immediate_improvements.forEach((rec, index) => {
            report += `${index + 1}. ${rec.area} (${rec.priority} Priority)\n`;
            report += `   Action: ${rec.action}\n\n`;
        });
    }
    
    report += `\nGenerated on: ${new Date().toLocaleString()}\n`;
    report += "Generated by: AI-Powered ATS Resume Insights\n";
    
    // Create and download file
    const blob = new Blob([report], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `resume_insights_${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    showAlert('Insights report downloaded successfully!', 'success');
}

// Skills Recommendations functionality
async function getSkillRecommendations(resumeId) {
    try {
        showAlert('Getting skill recommendations...', 'info', 0);
        
        // Get target role from user input or default
        const targetRole = prompt('Enter target job role for skill recommendations:', 'Software Engineer') || 'Software Engineer';
        
        const response = await fetch(`/api/resumes/${resumeId}/skill-recommendations?target_role=${encodeURIComponent(targetRole)}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        // Clear previous alerts
        document.querySelectorAll('.alert').forEach(alert => alert.remove());
        
        if (response.ok && data.success) {
            displaySkillRecommendationsModal(data.recommendations, targetRole);
        } else {
            showAlert(data.error || 'Failed to get skill recommendations', 'danger');
        }
        
    } catch (error) {
        console.error('Error fetching skill recommendations:', error);
        showAlert('Failed to get skill recommendations. Please try again.', 'danger');
    }
}

function displaySkillRecommendationsModal(recommendations, targetRole) {
    const modalHtml = `
        <div class="modal fade" id="skillRecommendationsModal" tabindex="-1" aria-labelledby="skillRecommendationsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="skillRecommendationsModalLabel">
                            <i class="fas fa-graduation-cap me-2"></i>Skill Recommendations for ${targetRole}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${generateSkillRecommendationsHTML(recommendations)}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="exportSkillRecommendations('${targetRole}', ${JSON.stringify(recommendations).replace(/"/g, '&quot;')})">
                            <i class="fas fa-download me-1"></i>Export Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('skillRecommendationsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('skillRecommendationsModal'));
    modal.show();
}

function generateSkillRecommendationsHTML(recommendations) {
    let html = '';
    
    // Skills gap analysis
    if (recommendations.skills_gap) {
        html += `
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-target me-2"></i>Skills Gap Analysis</h6>
                </div>
                <div class="card-body">
                    <div class="row">
        `;
        
        const skillGaps = recommendations.skills_gap.missing_skills || [];
        skillGaps.slice(0, 6).forEach(skill => {
            const priorityClass = skill.priority === 'High' ? 'danger' : 
                                skill.priority === 'Medium' ? 'warning' : 'info';
            html += `
                <div class="col-md-6 mb-3">
                    <div class="border rounded p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0">${skill.skill}</h6>
                            <span class="badge bg-${priorityClass}">${skill.priority}</span>
                        </div>
                        <p class="small text-muted mb-2">${skill.justification}</p>
                        <div class="small">
                            <strong>Market Value:</strong> <span class="text-success">${skill.market_value}</span>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                    </div>
                </div>
            </div>
        `;
    }
    
    // Learning recommendations
    if (recommendations.learning_path) {
        html += `
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-route me-2"></i>Recommended Learning Path</h6>
                </div>
                <div class="card-body">
        `;
        
        const learningSteps = recommendations.learning_path.steps || [];
        learningSteps.slice(0, 4).forEach((step, index) => {
            html += `
                <div class="d-flex mb-3">
                    <div class="flex-shrink-0">
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 30px; height: 30px;">
                            ${index + 1}
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="mb-1">${step.skill}</h6>
                        <p class="small text-muted mb-1">${step.description}</p>
                        <div class="small">
                            <span class="badge bg-light text-dark">${step.estimated_time}</span>
                            <span class="badge bg-success ms-1">${step.difficulty}</span>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    // Career advancement suggestions
    if (recommendations.career_advancement) {
        html += `
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Career Advancement</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Next Level Roles</h6>
        `;
        
        const nextRoles = recommendations.career_advancement.next_level_roles || [];
        nextRoles.slice(0, 3).forEach(role => {
            html += `
                <div class="mb-2">
                    <strong class="small">${role.title}</strong>
                    <p class="small text-muted mb-0">${role.requirements_gap}</p>
                </div>
            `;
        });
        
        html += `
                        </div>
                        <div class="col-md-6">
                            <h6>Industry Trends</h6>
        `;
        
        const trends = recommendations.career_advancement.industry_trends || [];
        trends.slice(0, 3).forEach(trend => {
            html += `
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span class="small">${trend.technology}</span>
                        <span class="badge bg-info small">${trend.growth_rate}</span>
                    </div>
                </div>
            `;
        });
        
        html += `
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    return html;
}

// Job Comparison functionality
async function compareWithJob(resumeId) {
    try {
        // First, let user select a job to compare with
        const jobId = await selectJobForComparison();
        if (!jobId) return;
        
        showAlert('Analyzing job match compatibility...', 'info', 0);
        
        const response = await fetch(`/api/resumes/${resumeId}/job-comparison`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ job_id: jobId })
        });
        
        const data = await response.json();
        
        // Clear previous alerts
        document.querySelectorAll('.alert').forEach(alert => alert.remove());
        
        if (response.ok && data.success) {
            displayJobComparisonModal(data.comparison);
        } else {
            showAlert(data.error || 'Failed to analyze job compatibility', 'danger');
        }
        
    } catch (error) {
        console.error('Error comparing with job:', error);
        showAlert('Failed to analyze job compatibility. Please try again.', 'danger');
    }
}

async function selectJobForComparison() {
    try {
        // Fetch available jobs
        const response = await fetch('/api/jobs/', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        const data = await response.json();
        
        if (!data.jobs || data.jobs.length === 0) {
            showAlert('No jobs available for comparison', 'warning');
            return null;
        }
        
        // Create job selection modal
        return new Promise((resolve) => {
            const modalHtml = `
                <div class="modal fade" id="jobSelectionModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Select Job for Comparison</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="list-group">
                                    ${data.jobs.map(job => `
                                        <button type="button" class="list-group-item list-group-item-action" onclick="selectJob(${job.id})">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1">${job.title}</h6>
                                                <small>${job.company}</small>
                                            </div>
                                            <p class="mb-1 small">${job.location}</p>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('jobSelectionModal'));
            modal.show();
            
            // Global function for job selection
            window.selectJob = (jobId) => {
                modal.hide();
                document.getElementById('jobSelectionModal').remove();
                resolve(jobId);
            };
        });
        
    } catch (error) {
        console.error('Error fetching jobs:', error);
        showAlert('Failed to load jobs for comparison', 'danger');
        return null;
    }
}

function displayJobComparisonModal(comparison) {
    const modalHtml = `
        <div class="modal fade" id="jobComparisonModal" tabindex="-1" aria-labelledby="jobComparisonModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="jobComparisonModalLabel">
                            <i class="fas fa-balance-scale me-2"></i>Job Compatibility Analysis
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${generateJobComparisonHTML(comparison)}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="exportJobComparison(${JSON.stringify(comparison).replace(/"/g, '&quot;')})">
                            <i class="fas fa-download me-1"></i>Export Analysis
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('jobComparisonModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('jobComparisonModal'));
    modal.show();
}

function generateJobComparisonHTML(comparison) {
    let html = '';
    
    // Overall compatibility score
    const compatibilityScore = comparison.overall_compatibility_score || 0;
    const scoreClass = compatibilityScore >= 80 ? 'success' : 
                      compatibilityScore >= 60 ? 'warning' : 'danger';
    
    html += `
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body text-center">
                        <h3 class="text-${scoreClass}">${compatibilityScore}%</h3>
                        <p class="lead">Overall Job Compatibility</p>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-${scoreClass}" style="width: ${compatibilityScore}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Detailed analysis sections
    if (comparison.detailed_analysis) {
        html += `
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>Strengths & Matches</h6>
                        </div>
                        <div class="card-body">
        `;
        
        const strengths = comparison.detailed_analysis.strengths || [];
        strengths.forEach(strength => {
            html += `
                <div class="mb-2">
                    <i class="fas fa-check text-success me-2"></i>
                    <strong>${strength.area}</strong>
                    <p class="small text-muted mb-0 ms-4">${strength.description}</p>
                </div>
            `;
        });
        
        html += `
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Areas for Improvement</h6>
                        </div>
                        <div class="card-body">
        `;
        
        const improvements = comparison.detailed_analysis.improvement_areas || [];
        improvements.forEach(improvement => {
            const priorityClass = improvement.priority === 'High' ? 'danger' : 
                                improvement.priority === 'Medium' ? 'warning' : 'info';
            html += `
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span><i class="fas fa-arrow-up text-${priorityClass} me-2"></i><strong>${improvement.area}</strong></span>
                        <span class="badge bg-${priorityClass}">${improvement.priority}</span>
                    </div>
                    <p class="small text-muted mb-0 ms-4">${improvement.suggestion}</p>
                </div>
            `;
        });
        
        html += `
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    return html;
}

// Export functions
function exportSkillRecommendations(targetRole, recommendations) {
    const content = `
# Skill Recommendations Report for ${targetRole}

Generated on: ${new Date().toLocaleDateString()}

## Skills Gap Analysis
${recommendations.skills_gap?.missing_skills?.map(skill => 
    `- **${skill.skill}** (${skill.priority} Priority): ${skill.justification}`
).join('\n') || 'No skill gaps identified'}

## Recommended Learning Path
${recommendations.learning_path?.steps?.map((step, index) => 
    `${index + 1}. **${step.skill}** - ${step.description} (${step.estimated_time})`
).join('\n') || 'No learning path available'}

## Career Advancement Opportunities
${recommendations.career_advancement?.next_level_roles?.map(role => 
    `- **${role.title}**: ${role.requirements_gap}`
).join('\n') || 'No advancement opportunities identified'}
    `;
    
    downloadTextFile(content, `skill-recommendations-${targetRole.replace(/\s+/g, '-').toLowerCase()}.md`);
}

function exportJobComparison(comparison) {
    const content = `
# Job Compatibility Analysis Report

Generated on: ${new Date().toLocaleDateString()}

## Overall Compatibility: ${comparison.overall_compatibility_score}%

## Strengths
${comparison.detailed_analysis?.strengths?.map(strength => 
    `- **${strength.area}**: ${strength.description}`
).join('\n') || 'No strengths identified'}

## Areas for Improvement
${comparison.detailed_analysis?.improvement_areas?.map(improvement => 
    `- **${improvement.area}** (${improvement.priority}): ${improvement.suggestion}`
).join('\n') || 'No improvement areas identified'}
    `;
    
    downloadTextFile(content, `job-compatibility-analysis-${Date.now()}.md`);
}

function downloadTextFile(content, filename) {
    const element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
    element.setAttribute('download', filename);
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
    
    showAlert('Report downloaded successfully!', 'success', 3000);
}
</script>
{% endblock %}
