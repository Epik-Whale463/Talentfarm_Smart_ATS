{% extends "base.html" %}

{% block title %}Candidate Dashboard - AI-Powered ATS{% endblock %}

{% block content %}
<style>
/* Japanese-inspired Bento Grid Layout - Optimized Space Usage */
.dashboard-bento {
    display: grid;
    grid-template-columns: repeat(16, 1fr);
    grid-template-rows: repeat(6, minmax(80px, auto));
    gap: 8px;
    margin-bottom: 1.5rem;
    max-width: 100%;
    padding: 0;
}

.bento-item {
    border-radius: 8px;
    padding: 0.8rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    transition: all 0.15s ease;
    position: relative;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.03);
    box-shadow: 0 1px 4px rgba(0,0,0,0.02);
    backdrop-filter: blur(8px);
    min-height: 75px;
}

.bento-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.06);
    border-color: rgba(0, 0, 0, 0.08);
}

/* Compact Grid Layout - Japanese Space Efficiency */
.welcome-header {
    grid-column: 1 / 9;
    grid-row: 1 / 2;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
    color: #2d3748;
    text-align: left;
    align-items: flex-start;
    justify-content: flex-start;
    border-left: 2px solid #667eea;
    padding: 1rem;
}

.profile-stats {
    grid-column: 9 / 13;
    grid-row: 1 / 2;
    background: linear-gradient(135deg, rgba(240, 147, 251, 0.08) 0%, rgba(245, 87, 108, 0.08) 100%);
    color: #2d3748;
    border-left: 2px solid #f093fb;
}

/* Insights Quick Action */
.insights-action {
    grid-column: 13 / 17;
    grid-row: 1 / 2;
    background: linear-gradient(135deg, rgba(138, 43, 226, 0.08) 0%, rgba(75, 0, 130, 0.08) 100%);
    color: #2d3748;
    border-left: 2px solid #8a2be2;
    cursor: pointer;
}

/* Compact Stats Row */
.resume-stat {
    grid-column: 1 / 4;
    grid-row: 2 / 3;
    background: linear-gradient(135deg, rgba(67, 233, 123, 0.08) 0%, rgba(56, 249, 215, 0.08) 100%);
    color: #2d3748;
    border-left: 2px solid #43e97b;
}

.application-stat {
    grid-column: 4 / 7;
    grid-row: 2 / 3;
    background: linear-gradient(135deg, rgba(250, 112, 154, 0.08) 0%, rgba(254, 225, 64, 0.08) 100%);
    color: #2d3748;
    border-left: 2px solid #fa709a;
}

.job-stat {
    grid-column: 7 / 10;
    grid-row: 2 / 3;
    background: linear-gradient(135deg, rgba(79, 172, 254, 0.08) 0%, rgba(0, 242, 254, 0.08) 100%);
    color: #2d3748;
    border-left: 2px solid #4facfe;
}

.match-stat {
    grid-column: 10 / 13;
    grid-row: 2 / 3;
    background: linear-gradient(135deg, rgba(255, 236, 210, 0.2) 0%, rgba(252, 182, 159, 0.2) 100%);
    color: #2d3748;
    border-left: 2px solid #fcb69f;
}

.interview-stat {
    grid-column: 13 / 17;
    grid-row: 2 / 3;
    background: linear-gradient(135deg, rgba(110, 193, 228, 0.15) 0%, rgba(254, 214, 227, 0.15) 100%);
    color: #2d3748;
    border-left: 2px solid #6ec1e4;
}

/* Compact Action Row */
.upload-action {
    grid-column: 1 / 6;
    grid-row: 3 / 4;
    background: linear-gradient(135deg, rgba(168, 237, 234, 0.15) 0%, rgba(254, 214, 227, 0.15) 100%);
    color: #2d3748;
    border-left: 2px solid #a8edea;
}

.browse-action {
    grid-column: 6 / 11;
    grid-row: 3 / 4;
    background: linear-gradient(135deg, rgba(255, 154, 158, 0.12) 0%, rgba(254, 207, 239, 0.12) 100%);
    color: #2d3748;
    border-left: 2px solid #ff9a9e;
}

.github-analysis-action {
    grid-column: 11 / 14;
    grid-row: 3 / 4;
    background: linear-gradient(135deg, rgba(36, 41, 46, 0.08) 0%, rgba(13, 17, 23, 0.08) 100%);
    color: #2d3748;
    border-left: 2px solid #24292e;
    cursor: pointer;
}

.quick-apply {
    grid-column: 14 / 17;
    grid-row: 3 / 4;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
    color: #2d3748;
    border-left: 2px solid #667eea;
}

/* Activity Dashboard Row */
.recent-resumes {
    grid-column: 1 / 9;
    grid-row: 4 / 7;
    background: linear-gradient(135deg, rgba(250, 208, 196, 0.15) 0%, rgba(255, 209, 255, 0.15) 100%);
    color: #2d3748;
    text-align: left;
    align-items: flex-start;
    border-left: 2px solid #fad0c4;
    min-height: 200px;
}

.recent-applications {
    grid-column: 9 / 17;
    grid-row: 4 / 7;
    background: linear-gradient(135deg, rgba(161, 140, 209, 0.12) 0%, rgba(251, 194, 235, 0.12) 100%);
    color: #2d3748;
    text-align: left;
    align-items: flex-start;
    border-left: 2px solid #a18cd1;
    min-height: 200px;
}

/* Responsive Design - Japanese Minimalist Approach */
@media (max-width: 1200px) {
    .dashboard-bento {
        grid-template-columns: repeat(12, 1fr);
    }
    
    .welcome-header { grid-column: 1 / 8; }
    .profile-stats { grid-column: 8 / 11; }
    .insights-action { grid-column: 11 / 13; }
    
    .resume-stat { grid-column: 1 / 4; }
    .application-stat { grid-column: 4 / 7; }
    .job-stat { grid-column: 7 / 10; }
    .match-stat { grid-column: 10 / 12; }
    .interview-stat { grid-column: 12 / 13; }
    
    .upload-action { grid-column: 1 / 4; }
    .browse-action { grid-column: 4 / 7; }
    .github-analysis-action { grid-column: 7 / 10; }
    .quick-apply { grid-column: 10 / 13; }
    
    .recent-resumes { grid-column: 1 / 7; grid-row: 4 / 7; }
    .recent-applications { grid-column: 7 / 13; grid-row: 4 / 7; }
}

@media (max-width: 768px) {
    .dashboard-bento {
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(12, minmax(70px, auto));
        gap: 6px;
        padding: 0;
    }
    
    .bento-item {
        padding: 0.6rem;
        min-height: 65px;
        text-align: center;
        align-items: center;
        justify-content: center;
    }
    
    /* Mobile Layout - Stacked Efficiently */
    .welcome-header { grid-column: 1 / 5; grid-row: 1 / 2; }
    .profile-stats { grid-column: 1 / 3; grid-row: 2 / 3; }
    .insights-action { grid-column: 3 / 5; grid-row: 2 / 3; }
    
    .resume-stat { grid-column: 1 / 2; grid-row: 3 / 4; }
    .application-stat { grid-column: 2 / 3; grid-row: 3 / 4; }
    .job-stat { grid-column: 3 / 4; grid-row: 3 / 4; }
    .match-stat { grid-column: 4 / 5; grid-row: 3 / 4; }
    .interview-stat { grid-column: 1 / 5; grid-row: 4 / 5; }
    
    .upload-action { grid-column: 1 / 5; grid-row: 5 / 6; }
    .browse-action { grid-column: 1 / 5; grid-row: 6 / 7; }
    .github-analysis-action { grid-column: 1 / 5; grid-row: 7 / 8; }
    .quick-apply { grid-column: 1 / 5; grid-row: 8 / 9; }
    
    .recent-resumes { grid-column: 1 / 5; grid-row: 9 / 11; }
    .recent-applications { grid-column: 1 / 5; grid-row: 11 / 13; }
    
    .welcome-header,
    .recent-resumes,
    .recent-applications {
        text-align: left;
        align-items: flex-start;
    }
}

@media (max-width: 480px) {
    .dashboard-bento {
        grid-template-columns: 1fr;
        gap: 4px;
    }
    
    .bento-item {
        grid-column: 1 !important;
        grid-row: auto !important;
        min-height: 60px;
        padding: 0.5rem;
    }
    
    .stat-number {
        font-size: 1.5rem;
    }
    
    .action-icon {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
    }
}

/* Compact Typography - Japanese Zen Approach */
.stat-number {
    font-size: 1.6rem;
    font-weight: 600;
    margin-bottom: 0.2rem;
    color: #2d3748;
    line-height: 1.1;
}

.stat-label {
    font-size: 0.75rem;
    opacity: 0.8;
    margin: 0;
    color: #4a5568;
    font-weight: 500;
    line-height: 1.2;
}

.action-icon {
    font-size: 1.4rem;
    margin-bottom: 0.5rem;
    opacity: 0.7;
    color: #4a5568;
}

/* Compact Action Buttons */
.bento-item .btn {
    padding: 0.4rem 0.8rem;
    font-size: 0.8rem;
    border-radius: 6px;
    font-weight: 500;
}

.bento-item h5 {
    font-size: 0.9rem;
    margin-bottom: 0.3rem;
    font-weight: 600;
    line-height: 1.2;
}

.bento-item .small {
    font-size: 0.7rem;
    margin-bottom: 0.5rem;
    opacity: 0.8;
    line-height: 1.2;
}

/* Optimized Recent Activity Lists */
.recent-item {
    background: rgba(255,255,255,0.3);
    border-radius: 6px;
    padding: 0.5rem;
    margin-bottom: 0.3rem;
    transition: all 0.15s ease;
    border: 1px solid rgba(0, 0, 0, 0.03);
    font-size: 0.8rem;
}

.recent-item:hover {
    background: rgba(255,255,255,0.5);
    transform: translateX(3px);
    border-color: rgba(0, 0, 0, 0.08);
}

.activity-list {
    max-height: 160px;
    overflow-y: auto;
    width: 100%;
}

.activity-list::-webkit-scrollbar {
    width: 2px;
}

.activity-list::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.1);
    border-radius: 1px;
}

.activity-list::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.3);
    border-radius: 1px;
}

/* Welcome Header Optimization */
.welcome-header h4 {
    font-size: 1.1rem;
    margin-bottom: 0.3rem;
    font-weight: 600;
}

.welcome-header .text-muted {
    font-size: 0.8rem;
    opacity: 0.7;
}

/* Quick Actions Compact Design */
.quick-actions-compact {
    background: rgba(248, 249, 250, 0.8);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
}

.quick-actions-compact .btn {
    padding: 0.4rem 0.8rem;
    margin: 0.2rem;
    font-size: 0.75rem;
    border-radius: 6px;
}

/* Insights Action Styling */
.insights-action {
    cursor: pointer;
    transition: all 0.15s ease;
}

.insights-action:hover {
    background: linear-gradient(135deg, rgba(138, 43, 226, 0.12) 0%, rgba(75, 0, 130, 0.12) 100%);
}

.insights-action .action-icon {
    color: #8a2be2;
}

/* Performance Optimizations */
.bento-item * {
    user-select: none;
}

.dashboard-bento {
    will-change: transform;
}

.activity-list {
    max-height: 180px;
    overflow-y: auto;
    width: 100%;
}

.activity-list::-webkit-scrollbar {
    width: 3px;
}

.activity-list::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.1);
    border-radius: 2px;
}

.activity-list::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.3);
    border-radius: 2px;
}

.recent-item {
    cursor: pointer;
}

.recent-item:hover {
    background: rgba(255,255,255,0.35) !important;
    transform: translateX(8px);
}

.fa-spin {
    animation: fa-spin 1s infinite linear;
}

@keyframes fa-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.stat-number.loading {
    opacity: 0.5;
    transition: opacity 0.3s ease;
}

.btn-outline-purple {
        border-color: #6f42c1;
        color: #6f42c1;
    }
    
    .btn-outline-purple:hover {
        background-color: #6f42c1;
        border-color: #6f42c1;
        color: white;
    }
    
    .insights-option-card {
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }
    
    .insights-option-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Timeline styles for skill gap analysis */
    .timeline {
        position: relative;
        padding: 20px 0;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 30px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #007bff;
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 30px;
        padding-left: 60px;
    }
    
    .timeline-marker {
        position: absolute;
        left: 22px;
        top: 5px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 2px solid #fff;
        box-shadow: 0 0 0 2px #007bff;
    }
    
    .timeline-content {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 3px solid #007bff;
    }
    
    .timeline-content h6 {
        margin-bottom: 10px;
        color: #007bff;
    }
    
    /* Match score visualization */
    .match-score-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
        color: white;
        margin: 0 auto;
    }
    
    .match-score-excellent {
        background: linear-gradient(135deg, #28a745, #20c997);
    }
    
    .match-score-good {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
    }
    
    .match-score-fair {
        background: linear-gradient(135deg, #fd7e14, #dc3545);
    }
    
    .match-score-poor {
        background: linear-gradient(135deg, #dc3545, #6f42c1);
    }
    
    /* Skill badges */
    .skill-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        margin: 0.125rem;
        border-radius: 12px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .skill-badge.matching {
        background-color: rgba(40, 167, 69, 0.1);
        color: #28a745;
        border: 1px solid rgba(40, 167, 69, 0.2);
    }
    
    .skill-badge.missing {
        background-color: rgba(255, 193, 7, 0.1);
        color: #ffc107;
        border: 1px solid rgba(255, 193, 7, 0.2);
    }
    
    /* Application status indicators */
    .status-indicator {
        position: relative;
        display: inline-block;
    }
    
    .status-indicator::before {
        content: '';
        position: absolute;
        left: -10px;
        top: 50%;
        transform: translateY(-50%);
        width: 6px;
        height: 6px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    .status-indicator.pending::before {
        background-color: #ffc107;
    }
    
    .status-indicator.reviewing::before {
        background-color: #007bff;
    }
    
    .status-indicator.interview::before {
        background-color: #17a2b8;
    }
    
    .status-indicator.accepted::before {
        background-color: #28a745;
    }
    
    .status-indicator.rejected::before {
        background-color: #dc3545;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    /* Interview notification styles */
    .interview-notification {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .interview-card {
        transition: transform 0.2s ease;
    }
    
    .interview-card:hover {
        transform: translateY(-2px);
    }
    
    .interview-upcoming {
        border-left: 4px solid #28a745;
    }
    
    .interview-today {
        border-left: 4px solid #ffc107;
        animation: pulse 2s infinite;
    }
</style>

<div class="dashboard-bento">
    <!-- Welcome Header -->
    <div class="bento-item welcome-header">
        <div class="w-100">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <h4 class="mb-0 fw-bold">
                    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                </h4>
                <button class="btn btn-sm btn-outline-primary" onclick="forceRefresh()" title="Refresh Data">
                    <i class="fas fa-sync-alt" id="refreshIcon"></i>
                </button>
            </div>
            <p class="mb-1" id="welcomeMessage">Welcome back!</p>
            <div class="d-flex align-items-center gap-3 mt-1">
                <small class="text-success">
                    <i class="fas fa-circle me-1" style="font-size: 0.4rem;"></i>
                    Live updates
                </small>
                <small class="text-muted" id="lastUpdated">Loading...</small>
                <span id="connectionStatus"></span>
            </div>
        </div>
    </div>

    <!-- Profile Stats -->
    <div class="bento-item profile-stats">
        <i class="fas fa-user-circle action-icon"></i>
        <h5 class="mb-2">Profile Status</h5>
        <div id="profileCompletion" class="stat-number">85%</div>
        <p class="stat-label">Complete</p>
    </div>

    <!-- AI Insights Quick Action -->
    <div class="bento-item insights-action" onclick="showInsightsOptions()" title="Get AI-powered resume insights">
        <i class="fas fa-brain action-icon"></i>
        <h5 class="mb-1">AI Insights</h5>
        <p class="stat-label">Smart Analysis</p>
    </div>

    <!-- Resume Statistics -->
    <div class="bento-item resume-stat">
        <i class="fas fa-file-alt action-icon"></i>
        <div class="stat-number" id="resumeCount">0</div>
        <p class="stat-label">Resumes Uploaded</p>
    </div>

    <!-- Application Statistics -->
    <div class="bento-item application-stat">
        <i class="fas fa-paper-plane action-icon"></i>
        <div class="stat-number" id="applicationCount">0</div>
        <p class="stat-label">Applications Sent</p>
    </div>

    <!-- Job Statistics -->
    <div class="bento-item job-stat">
        <i class="fas fa-search action-icon"></i>
        <div class="stat-number" id="jobCount">0</div>
        <p class="stat-label">Available Jobs</p>
    </div>

    <!-- Match Score -->
    <div class="bento-item match-stat">
        <i class="fas fa-chart-line action-icon text-warning"></i>
        <div class="stat-number text-warning" id="avgMatchScore">0%</div>
        <p class="stat-label">Avg Match Score</p>
    </div>

    <!-- Interview Statistics -->
    <div class="bento-item interview-stat" onclick="viewCandidateInterviews()" style="cursor: pointer;">
        <i class="fas fa-calendar-check action-icon text-info"></i>
        <div class="stat-number text-info" id="interviewCount">0</div>
        <p class="stat-label">Upcoming Interviews</p>
    </div>

    <!-- Upload Action -->
    <div class="bento-item upload-action">
        <i class="fas fa-upload action-icon text-primary"></i>
        <h5 class="mb-2">Upload Resume</h5>
        <p class="small mb-3">AI-powered parsing and analysis</p>
        <a href="{{ url_for('dashboard.resumes_page') }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Upload New
        </a>
    </div>

    <!-- Browse Jobs Action -->
    <div class="bento-item browse-action">
        <i class="fas fa-briefcase action-icon text-success"></i>
        <h5 class="mb-2">Browse Jobs</h5>
        <p class="small mb-3">Find perfect matches for your skills</p>
        <a href="{{ url_for('dashboard.jobs_page') }}" class="btn btn-success">
            <i class="fas fa-search me-2"></i>View Jobs
        </a>
    </div>

    <!-- GitHub Analysis Action -->
    <div class="bento-item github-analysis-action" onclick="showGitHubAnalysis()" title="Analyze your GitHub repositories">
        <i class="fab fa-github action-icon"></i>
        <h5 class="mb-2">GitHub Analysis</h5>
        <p class="small mb-3">AI-powered code assessment</p>
        <button class="btn btn-dark" id="githubAnalysisBtn">
            <i class="fas fa-code me-2"></i>Analyze Code
        </button>
    </div>

    <!-- Quick Apply -->
    <div class="bento-item quick-apply">
        <i class="fas fa-bolt action-icon"></i>
        <h5 class="mb-2">Quick Apply</h5>
        <p class="small mb-3">One-click applications</p>
        <button class="btn btn-light" onclick="findQuickMatches()">
            <i class="fas fa-magic me-2"></i>Find Matches
        </button>
    </div>

    <!-- Recent Resumes -->
    <div class="bento-item recent-resumes">
        <div class="w-100">
            <div class="d-flex align-items-center mb-3">
                <i class="fas fa-file-alt me-2 text-primary"></i>
                <h5 class="mb-0">Recent Resumes</h5>
            </div>
            <div class="activity-list" id="recentResumes">
                <p class="text-muted text-center">Loading...</p>
            </div>
        </div>
    </div>

    <!-- Recent Applications -->
    <div class="bento-item recent-applications">
        <div class="w-100">
            <div class="d-flex align-items-center mb-3">
                <i class="fas fa-paper-plane me-2 text-success"></i>
                <h5 class="mb-0">Recent Applications</h5>
            </div>
            <div class="activity-list" id="recentApplications">
                <p class="text-muted text-center">Loading...</p>
            </div>
        </div>
    </div>
</div>

<!-- Compact Quick Actions -->
<div class="quick-actions-compact">
    <div class="d-flex flex-wrap justify-content-center gap-1">
        <a href="{{ url_for('dashboard.profile_page') }}" class="btn btn-outline-primary btn-sm">
            <i class="fas fa-user me-1"></i>Profile
        </a>
        <a href="{{ url_for('dashboard.resumes_page') }}" class="btn btn-outline-success btn-sm">
            <i class="fas fa-file-alt me-1"></i>Resumes
        </a>
        <a href="{{ url_for('dashboard.jobs_page') }}" class="btn btn-outline-info btn-sm">
            <i class="fas fa-briefcase me-1"></i>Jobs
        </a>
        <button class="btn btn-outline-warning btn-sm" onclick="viewCandidateInterviews()">
            <i class="fas fa-calendar-alt me-1"></i>Interviews
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="showAnalytics()">
            <i class="fas fa-chart-bar me-1"></i>Analytics
        </button>
        <button class="btn btn-outline-dark btn-sm" onclick="forceRefresh()">
            <i class="fas fa-sync-alt me-1" id="refreshIcon"></i>Refresh
        </button>
    </div>
    <div class="text-center mt-2">
        <small class="text-muted">
            <i class="fas fa-clock me-1"></i>
            <span id="lastUpdatedFooter">Loading...</span>
        </small>
        <span id="connectionStatusFooter"></span>
    </div>
</div>

<!-- Interview Notification Modal (Hidden by default) -->
<div class="modal fade" id="interviewNotificationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-alt me-2"></i>Interview Scheduled!
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="fas fa-handshake fa-3x text-success mb-2"></i>
                    <h6>Great news! You have been scheduled for an interview.</h6>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">${interview.title}</h6>
                        <p><strong>Position:</strong> ${interview.job_title || 'N/A'}</p>
                        <p><strong>Company:</strong> ${interview.company || 'N/A'}</p>
                        <p><strong>Type:</strong> 
                            <span class="badge bg-secondary">${interview.interview_type}</span>
                        </p>
                        <p><strong>Date & Time:</strong><br>
                            <span class="text-primary fw-bold">
                                ${new Date(interview.scheduled_at).toLocaleDateString()} at 
                                ${new Date(interview.scheduled_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            </span>
                        </p>
                        <p><strong>Duration:</strong> ${interview.duration_minutes} minutes</p>
                        ${interview.location ? `<p><strong>Location:</strong> ${interview.location}</p>` : ''}
                        ${interview.meeting_link ? `
                            <p><strong>Meeting Link:</strong><br>
                                <a href="${interview.meeting_link}" target="_blank" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-video me-1"></i>Join Meeting
                                </a>
                            </p>
                        ` : ''}
                        ${interview.description ? `<p><strong>Description:</strong><br>${interview.description}</p>` : ''}
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Tips:</strong> Prepare for your interview by reviewing the job description and researching the company. Good luck!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="viewCandidateInterviews(); bootstrap.Modal.getInstance(document.getElementById('interviewNotificationModal')).hide();">
                    <i class="fas fa-calendar me-1"></i>View All Interviews
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
// Global variables for real-time updates
let socket;
let refreshInterval;
let lastUpdateTime = 0;
let isConnected = false;

// Helper function to get auth headers
function getAuthHeaders() {
    const token = localStorage.getItem('token');
    return token ? { 'Authorization': `Bearer ${token}` } : {};
}

// Helper function to show alerts
function showAlert(message, type = 'info', duration = 5000) {
    // Remove existing alerts
    const existingAlerts = document.querySelectorAll('.alert-floating');
    existingAlerts.forEach(alert => alert.remove());
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed alert-floating`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after specified duration (unless duration is 0)
    if (duration > 0) {
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, duration);
    }
}

// Helper function to show toasts
function showToast(message, type = 'info', duration = 5000) {
    showAlert(message, type, duration);
}

// Helper functions for loading states
function showLoadingState() {
    const loadingElements = document.querySelectorAll('.stat-number');
    loadingElements.forEach(el => {
        if (!el.classList.contains('loading')) {
            el.classList.add('loading');
            el.textContent = '...';
        }
    });
}

function hideLoadingState() {
    const loadingElements = document.querySelectorAll('.stat-number.loading');
    loadingElements.forEach(el => {
        el.classList.remove('loading');
    });
}

function showErrorState(message) {
    showAlert(message, 'danger');
    hideLoadingState();
}

document.addEventListener('DOMContentLoaded', function() {
    initializeRealTimeConnection();
    loadDashboardData();
});

function initializeRealTimeConnection() {
    const token = localStorage.getItem('token');
    if (!token) {
        console.error('No authentication token found');
        return;
    }
    
    // Initialize Socket.IO connection
    socket = io({
        query: { token: token }
    });
    
    // Connection events
    socket.on('connect', function() {
        console.log('Connected to real-time service');
        isConnected = true;
        updateConnectionStatus(true);
        
        // Join user room for personalized updates
        socket.emit('join_user_room', {});
    });
    
    socket.on('disconnect', function() {
        console.log('Disconnected from real-time service');
        isConnected = false;
        updateConnectionStatus(false);
    });
    
    socket.on('connect_error', function(error) {
        console.error('Connection error:', error);
        isConnected = false;
        updateConnectionStatus(false);
    });
    
    // Real-time data updates
    socket.on('dashboard_update', function(data) {
        console.log('Dashboard update received:', data);
        updateDashboardUI(data);
        
        // Show notification for specific events
        if (data.event) {
            handleRealTimeEvent(data.event);
        }
    });
    
    socket.on('new_job_posted', function(data) {
        console.log('New job posted:', data);
        showToast(`New job posted: ${data.job.title} at ${data.job.company}`, 'info');
        
        // Update job count if available
        const jobCountEl = document.getElementById('jobCount');
        if (jobCountEl) {
            const currentCount = parseInt(jobCountEl.textContent) || 0;
            jobCountEl.textContent = currentCount + 1;
        }
    });
    
    socket.on('application_status_changed', function(data) {
        console.log('Application status changed:', data);
        showToast(`Application status updated: ${data.application.job_title} - ${data.application.status}`, 'info');
        
        // Refresh dashboard data
        loadDashboardData();
    });
    
    socket.on('interview_scheduled', function(data) {
        console.log('Interview scheduled:', data);
        showToast(`Interview scheduled for ${data.interview.job_title} on ${new Date(data.interview.scheduled_at).toLocaleDateString()}`, 'success', 10000);
        
        // Update interview count and refresh dashboard
        loadInterviewCount();
        loadDashboardData();
        
        // Show interview notification modal
        showInterviewNotificationModal(data.interview);
    });
    
    socket.on('interview_updated', function(data) {
        console.log('Interview updated:', data);
        showToast(`Interview updated: ${data.interview.title}`, 'info');
        
        // Refresh dashboard data
        loadInterviewCount();
        loadDashboardData();
    });
    
    socket.on('interview_cancelled', function(data) {
        console.log('Interview cancelled:', data);
        showToast(`Interview cancelled: ${data.interview.title}`, 'warning');
        
        // Refresh dashboard data
        loadInterviewCount();
        loadDashboardData();
    });
    
    socket.on('error', function(error) {
        console.error('Socket error:', error);
        showToast(error.message || 'Real-time connection error', 'danger');
    });
    
    socket.on('joined_room', function(data) {
        console.log('Joined real-time room:', data);
        showToast('Connected to live updates', 'success', 3000);
    });
}

function updateConnectionStatus(connected) {
    const statusIndicators = ['connectionStatus', 'connectionStatusFooter'];
    
    statusIndicators.forEach(indicatorId => {
        let indicator = document.getElementById(indicatorId);
        if (!indicator && indicatorId === 'connectionStatus') {
            // Create status indicator if it doesn't exist for header
            indicator = document.createElement('small');
            indicator.id = indicatorId;
            indicator.className = 'opacity-50';
            const lastUpdatedEl = document.getElementById('lastUpdated');
            if (lastUpdatedEl && lastUpdatedEl.parentNode) {
                lastUpdatedEl.parentNode.insertBefore(indicator, lastUpdatedEl.nextSibling);
            }
        }
        
        if (indicator) {
            if (connected) {
                indicator.innerHTML = ' • <span class="text-success">Live</span>';
            } else {
                indicator.innerHTML = ' • <span class="text-danger">Offline</span>';
            }
        }
    });
}

function handleRealTimeEvent(event) {
    switch (event.type) {
        case 'resume_uploaded':
            showToast(`Resume "${event.data.filename}" uploaded successfully!`, 'success');
            break;
        case 'application_submitted':
            showToast(`Applied to ${event.data.job_title} at ${event.data.company} (${event.data.match_score}% match)`, 'success');
            break;
        case 'application_withdrawn':
            showToast(`Application withdrawn from ${event.data.job_title}`, 'info');
            break;
        default:
            console.log('Unhandled real-time event:', event);
    }
}

function updateDashboardUI(data) {
    try {
        if (data.error) {
            console.error('Dashboard data error:', data.error);
            return;
        }
        
        // Update statistics
        if (data.statistics) {
            const stats = data.statistics;
            updateStatElement('resumeCount', stats.resume_count);
            updateStatElement('applicationCount', stats.application_count);
            updateStatElement('jobCount', stats.job_count);
            updateStatElement('avgMatchScore', `${stats.avg_match_score}%`);
            updateStatElement('profileCompletion', `${stats.profile_completion}%`);
        }
        
        // Load interview count separately
        loadInterviewCount();
        
        // Update recent resumes
        if (data.recent_resumes) {
            displayRecentResumes(data.recent_resumes);
        }
        
        // Update recent applications
        if (data.recent_applications) {
            displayRecentApplications(data.recent_applications);
        }
        
        // Update welcome message
        if (data.user && data.user.name) {
            const welcomeEl = document.getElementById('welcomeMessage');
            if (welcomeEl) {
                welcomeEl.textContent = `Welcome back, ${data.user.name}!`;
            }
        }
        
        // Update last refresh time
        lastUpdateTime = Date.now();
        updateLastUpdatedIndicator();
        hideLoadingState();
        
    } catch (error) {
        console.error('Error updating dashboard UI:', error);
    }
}

function updateStatElement(elementId, value) {
    const element = document.getElementById(elementId);
    if (element && element.textContent !== value.toString()) {
        element.classList.add('loading');
        setTimeout(() => {
            element.textContent = value;
            element.classList.remove('loading');
            
            // Add a subtle animation
            element.style.transform = 'scale(1.1)';
            setTimeout(() => {
                element.style.transform = 'scale(1)';
            }, 200);
        }, 150);
    }
}

async function loadDashboardData() {
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    
    // Set welcome message
    const welcomeEl = document.getElementById('welcomeMessage');
    if (welcomeEl && user.name) {
        welcomeEl.textContent = `Welcome back, ${user.name}!`;
    }
    
    try {
        // Show loading state
        showLoadingState();
        
        // If socket is connected, request real-time update
        if (socket && isConnected) {
            socket.emit('request_dashboard_update', {});
            return; // Real-time update will handle UI refresh
        }
        
        // Fallback to API calls if socket not available
        Promise.all([
            fetch('/api/resumes/list', { headers: getAuthHeaders() }),
            fetch('/api/jobs/', { headers: getAuthHeaders() }),
            fetch('/api/jobs/applications/me/with-analysis', { headers: getAuthHeaders() })
        ])
        .then(responses => {
            // Check if all responses are ok
            const validResponses = responses.filter(r => r.ok);
            if (validResponses.length === 0) {
                throw new Error('All API requests failed');
            }
            
            // Handle partial failures gracefully
            return Promise.all(responses.map(async (r, index) => {
                if (r.ok) {
                    return await r.json();
                } else {
                    console.warn(`API request ${index} failed with status ${r.status}`);
                    return null;
                }
            }));
        })
        .then(([resumesData, jobsData, applicationStats]) => {
            // Update UI with API data
            if (resumesData && resumesData.resumes) {
                document.getElementById('resumeCount').textContent = resumesData.resumes.length;
                displayRecentResumes(resumesData.resumes.slice(0, 5));
            } else {
                document.getElementById('resumeCount').textContent = 0;
                displayRecentResumes([]);
            }
            
            if (jobsData) {
                document.getElementById('jobCount').textContent = jobsData.jobs ? jobsData.jobs.length : 0;
            } else {
                document.getElementById('jobCount').textContent = 0;
            }
            
            if (applicationStats) {
                document.getElementById('applicationCount').textContent = applicationStats.total || 0;
                const applicationsWithScores = applicationStats.applications?.filter(app => app.match_score) || [];
                const avgMatchScore = applicationsWithScores.length > 0 
                    ? applicationsWithScores.reduce((sum, app) => sum + app.match_score, 0) / applicationsWithScores.length 
                    : 0;
                document.getElementById('avgMatchScore').textContent = `${Math.round(avgMatchScore)}%`;
                displayRecentApplications(applicationStats.applications?.slice(0, 5) || []);
                
                // Update profile completion if available
                if (applicationStats.profile_completion !== undefined) {
                    document.getElementById('profileCompletion').textContent = `${Math.round(applicationStats.profile_completion)}%`;
                }
            }
            
            // Update last refresh time
            lastUpdateTime = Date.now();
            updateLastUpdatedIndicator();
            hideLoadingState();
        })
        .catch(error => {
            console.error('Error loading dashboard data:', error);
            showErrorState('Failed to load dashboard data. Please refresh the page.');
        });
        
    } catch (error) {
        console.error('Error in dashboard initialization:', error);
        showErrorState('Failed to load dashboard data. Please refresh the page.');
    }
}

function forceRefresh() {
    const refreshIcon = document.getElementById('refreshIcon');
    refreshIcon.classList.add('fa-spin');
    
    if (socket && isConnected) {
        socket.emit('request_dashboard_update', {});
        setTimeout(() => {
            refreshIcon.classList.remove('fa-spin');
        }, 1000);
    } else {
        loadDashboardData().finally(() => {
            refreshIcon.classList.remove('fa-spin');
        });
    }
}

function updateLastUpdatedIndicator() {
    const now = new Date();
    const timeString = now.toLocaleTimeString();
    
    const lastUpdatedElements = ['lastUpdated', 'lastUpdatedFooter'];
    lastUpdatedElements.forEach(elementId => {
        const element = document.getElementById(elementId);
        if (element) {
            if (elementId === 'lastUpdated') {
                element.textContent = `Last updated: ${timeString}`;
            } else {
                element.textContent = `Last updated: ${timeString}`;
            }
        }
    });
}

// Enhanced functions with better error handling
async function loadResumes(token) {
    try {
        const response = await fetch('/api/resumes/list', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            return await response.json();
        }
        throw new Error('Failed to load resumes');
    } catch (error) {
        console.error('Error loading resumes:', error);
        return null;
    }
}

async function loadJobs() {
    try {
        const response = await fetch('/api/jobs/', {
            headers: getAuthHeaders()
        });
        
        if (response.ok) {
            return await response.json();
        }
        throw new Error('Failed to load jobs');
    } catch (error) {
        console.error('Error loading jobs:', error);
        return null;
    }
}

async function loadApplicationStats(token) {
    try {
        const response = await fetch('/api/jobs/applications/stats/me', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            return await response.json();
        }
        throw new Error('Failed to load application stats');
    } catch (error) {
        console.error('Error loading application stats:', error);
        return null;
    }
}

function displayRecentResumes(resumes) {
    const container = document.getElementById('recentResumes');
    if (!container) return;
    
    if (!resumes || resumes.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No resumes uploaded yet</p>';
        return;
    }
    
    container.innerHTML = resumes.map(resume => `
        <div class="recent-item">
            <div class="d-flex justify-content-between align-items-center">
                <div onclick="viewResume(${resume.id})" style="cursor: pointer; flex-grow: 1;">
                    <strong>${resume.filename || 'Unnamed Resume'}</strong>
                    <br>
                    <small class="text-muted">
                        ${resume.skills ? resume.skills.length : 0} skills • 
                        ${new Date(resume.created_at).toLocaleDateString()}
                    </small>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); viewResumeFile(${resume.id})" title="View Resume">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); getResumeInsights(${resume.id})" title="Get AI Insights">
                        <i class="fas fa-brain"></i>
                    </button>
                    <i class="fas fa-chevron-right text-muted"></i>
                </div>
            </div>
        </div>
    `).join('');
}

function displayRecentApplications(applications) {
    const container = document.getElementById('recentApplications');
    if (!container) return;
    
    if (!applications || applications.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No applications yet</p>';
        return;
    }
    
    container.innerHTML = applications.map(app => `
        <div class="recent-item" onclick="viewApplicationWithAnalysis(${app.id})">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${app.job?.title || app.job_title || 'Unknown Job'}</strong>
                    <br>
                    <small class="text-muted">
                        ${app.job?.company || app.company || 'Unknown Company'} • 
                        <span class="badge bg-${getStatusColor(app.status)} text-white me-1">
                            ${app.status || 'pending'}
                        </span>
                        ${typeof app.match_score === 'number' ? 
                            `<span class="badge bg-${app.match_score >= 80 ? 'success' : app.match_score >= 60 ? 'warning' : 'danger'}">
                                ${Math.round(app.match_score)}% match
                            </span>` : 
                            '<span class="badge bg-secondary">No analysis</span>'
                        }
                    </small>
                </div>
                <div class="d-flex align-items-center gap-2">
                    ${typeof app.match_score === 'number' ? 
                        `<div class="text-center">
                            <div class="small text-muted">Match</div>
                            <div class="fw-bold text-${app.match_score >= 80 ? 'success' : app.match_score >= 60 ? 'warning' : 'danger'}">
                                ${Math.round(app.match_score)}%
                            </div>
                        </div>` : 
                        `<button class="btn btn-sm btn-outline-info" onclick="event.stopPropagation(); analyzeApplicationMatch(${app.id})" title="Analyze Match">
                            <i class="fas fa-chart-line"></i>
                        </button>`
                    }
                    <i class="fas fa-chevron-right text-muted"></i>
                </div>
            </div>
        </div>
    `).join('');
}

function getStatusColor(status) {
    if (!status) return 'secondary';
    
    switch (status.toLowerCase()) {
        case 'accepted': 
        case 'hired': return 'success';
        case 'rejected': return 'danger';
        case 'pending': return 'warning';
        case 'interview': 
        case 'interviewing': return 'info';
        case 'withdrawn': return 'dark';
        case 'reviewing': return 'primary';
        default: return 'secondary';
    }
}

// Navigation functions
async function viewApplication(applicationId) {
    try {
        // Show loading toast
        showToast('Loading application details...', 'info');
        
        const response = await fetch(`/api/jobs/applications/${applicationId}`, {
            headers: getAuthHeaders()
        });
        
        if (response.ok) {
            const application = await response.json();
            showApplicationDetails(application);
        } else {
            throw new Error('Could not load application details');
        }
    } catch (error) {
        console.error('Error viewing application:', error);
        showToast('Could not load application details', 'danger');
    }
}

function showApplicationDetails(application) {
    // Create modal for application details if it doesn't exist
    let modal = document.getElementById('applicationDetailModal');
    
    if (!modal) {
        const modalHtml = `
            <div class="modal fade" id="applicationDetailModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Application Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="applicationDetailContent">
                            <!-- Content will be loaded here -->
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-danger" id="withdrawApplicationBtn">
                                Withdraw Application
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        modal = document.getElementById('applicationDetailModal');
        
        // Add event handler for withdraw button
        document.getElementById('withdrawApplicationBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to withdraw this application?')) {
                withdrawApplication(currentApplicationId);
            }
        });
    }
    
    // Store current application ID
    window.currentApplicationId = application.id;
    
    // Format application content
    const content = document.getElementById('applicationDetailContent');
    const matchScore = typeof application.match_score === 'number' ? 
        Math.round(application.match_score * 100) : 'N/A';
    
    content.innerHTML = `
        <div class="row mb-4">
            <div class="col-md-8">
                <h4>${application.job_title || 'Unknown Job'}</h4>
                <h6 class="text-muted">${application.company || 'Unknown Company'}</h6>
            </div>
            <div class="col-md-4 text-end">
                <div class="badge bg-${getStatusColor(application.status)} fs-5">${application.status || 'Pending'}</div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">Application Details</div>
                    <div class="card-body">
                        <p><strong>Applied on:</strong> ${new Date(application.applied_at).toLocaleDateString()}</p>
                        <p><strong>Status:</strong> ${application.status || 'Pending'}</p>
                        <p><strong>Match Score:</strong> ${matchScore}%</p>
                        ${application.feedback ? `<p><strong>Feedback:</strong> ${application.feedback}</p>` : ''}
                        ${application.interview_date ? 
                            `<p><strong>Interview Date:</strong> ${new Date(application.interview_date).toLocaleString()}</p>` : ''}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">Resume Used</div>
                    <div class="card-body">
                        <p><strong>Resume:</strong> ${application.resume_name || 'Unknown'}</p>
                        ${application.cover_letter ? 
                            `<div class="mt-3">
                                <strong>Cover Letter:</strong>
                                <div class="border rounded p-2 mt-1 bg-light">${application.cover_letter}</div>
                            </div>` : 
                            '<p>No cover letter submitted</p>'}
                    </div>
                </div>
            </div>
        </div>
        
        ${application.match_analysis ? `
            <div class="card mb-4">
                <div class="card-header">Skill Match Analysis</div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="progress flex-grow-1 me-2" style="height: 20px;">
                            <div class="progress-bar bg-success" style="width: ${matchScore}%">${matchScore}%</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Matching Skills</h6>
                            <ul class="list-group">
                                ${application.match_analysis.matching_skills?.map(skill => 
                                    `<li class="list-group-item d-flex align-items-center">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        ${skill}
                                    </li>`
                                ).join('') || '<li class="list-group-item">No matching skills found</li>'}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Missing Skills</h6>
                            <ul class="list-group">
                                ${application.match_analysis.missing_skills?.map(skill => 
                                    `<li class="list-group-item d-flex align-items-center">
                                        <i class="fas fa-times-circle text-danger me-2"></i>
                                        ${skill}
                                    </li>`
                                ).join('') || '<li class="list-group-item">No missing skills found</li>'}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        ` : ''}
        
        ${application.status_history?.length > 0 ? `
            <div class="card">
                <div class="card-header">Status History</div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        ${application.status_history.map(history => `
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between">
                                    <span>${history.status}</span>
                                    <small class="text-muted">${new Date(history.timestamp).toLocaleString()}</small>
                                </div>
                                ${history.note ? `<small class="text-muted">${history.note}</small>` : ''}
                            </li>
                        `).join('')}
                    </ul>
                </div>
            </div>
        ` : ''}
    `;
    
    // Show withdraw button only if application is not already withdrawn
    const withdrawBtn = document.getElementById('withdrawApplicationBtn');
    withdrawBtn.style.display = ['withdrawn', 'rejected', 'hired'].includes(application.status?.toLowerCase()) ? 'none' : 'block';
    
    // Show the modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

async function withdrawApplication(applicationId) {
    try {
        const response = await fetch(`/api/jobs/applications/${applicationId}/withdraw`, {
            method: 'DELETE',
            headers: getAuthHeaders()
        });
        
        if (response.ok) {
            showToast('Application successfully withdrawn', 'success');
            
            // Hide the modal
            bootstrap.Modal.getInstance(document.getElementById('applicationDetailModal')).hide();
            
            // Refresh dashboard data
            loadDashboardData();
            
            // Emit socket event if available
            if (socket && socket.connected) {
                socket.emit('application_withdrawn', { application_id: applicationId });
            }
        } else {
            const data = await response.json();
            throw new Error(data.message || 'Failed to withdraw application');
        }
    } catch (error) {
        console.error('Error withdrawing application:', error);
        showToast(error.message || 'Error withdrawing application', 'danger');
    }
}

// Resume viewing functionality
async function viewResumeFile(resumeId) {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/resumes/${resumeId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const data = await response.json();
            const resume = data.resume;
            const parsedData = resume.parsed_data || {};
            
            // Create a simple display of resume data
            let resumeInfo = `Resume: ${resume.filename}\n\n`;
            
            if (parsedData.name) {
                resumeInfo += `Name: ${parsedData.name}\n`;
            }
            if (parsedData.email) {
                resumeInfo += `Email: ${parsedData.email}\n`;
            }
            if (parsedData.phone) {
                resumeInfo += `Phone: ${parsedData.phone}\n`;
            }
            if (parsedData.skills && parsedData.skills.length > 0) {
                resumeInfo += `\nSkills: ${parsedData.skills.join(', ')}\n`;
            }
            if (parsedData.experience && parsedData.experience.length > 0) {
                resumeInfo += `\nExperience:\n`;
                parsedData.experience.forEach((exp, index) => {
                    resumeInfo += `${index + 1}. ${exp.title || 'Position'} at ${exp.company || 'Company'}\n`;
                });
            }
            
            // Show in a more user-friendly way - navigate to resumes page
            showAlert('Resume details loaded. Redirecting to full resume view...', 'info');
            setTimeout(() => {
                window.location.href = '/resumes';
            }, 1500);
            
        } else {
            showAlert('Failed to load resume details', 'danger');
        }
    } catch (error) {
        console.error('Error viewing resume:', error);
        showAlert('Failed to load resume details', 'danger');
    }
}

// Resume Insights functionality
async function getResumeInsights(resumeId) {
    try {
        // Show loading indicator
        showAlert('Generating AI insights for your resume...', 'info', 0);
        
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/resumes/${resumeId}/insights`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        // Remove loading alert
        const alertContainer = document.getElementById('alertContainer');
        if (alertContainer) {
            alertContainer.innerHTML = '';
        }
        
        if (data.success) {
            displayInsightsModal(data.insights);
        } else {
            showAlert(data.error || 'Failed to generate insights', 'danger');
        }
        
    } catch (error) {
        console.error('Error fetching resume insights:', error);
        showAlert('Failed to generate insights. Please try again.', 'danger');
    }
}

function displayInsightsModal(insights) {
    // Create modal HTML
    const modalHtml = `
        <div class="modal fade" id="insightsModal" tabindex="-1" aria-labelledby="insightsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="insightsModalLabel">
                            <i class="fas fa-brain me-2"></i>AI Resume Insights
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        ${generateInsightsHTML(insights)}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="downloadInsightsReport(${JSON.stringify(insights).replace(/"/g, '&quot;')})">
                            <i class="fas fa-download me-1"></i>Download Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('insightsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('insightsModal'));
    modal.show();
}

function generateInsightsHTML(insights) {
    let html = '';
    
    console.log('Candidate Dashboard - Insights data:', insights); // Debug log
    
    // Handle both old and new format
    const llmAnalysis = insights.llm_analysis || insights;
    
    // Executive Summary
    if (llmAnalysis.executive_summary) {
        html += `
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Executive Summary</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <div class="display-4 text-primary">${llmAnalysis.executive_summary.overall_score || 'N/A'}/10</div>
                            <small class="text-muted">Overall Score</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="h4 text-${getScoreColor(llmAnalysis.executive_summary.technical_level)}">${llmAnalysis.executive_summary.technical_level || 'N/A'}</div>
                            <small class="text-muted">Technical Level</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="h4 text-${getRecommendationColor(llmAnalysis.executive_summary.hire_confidence)}">${llmAnalysis.executive_summary.hire_confidence || 'N/A'}</div>
                            <small class="text-muted">Hire Confidence</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="h5 text-${getRiskColor(llmAnalysis.executive_summary.risk_level)}">${llmAnalysis.executive_summary.risk_level || 'N/A'}</div>
                            <small class="text-muted">Risk Level</small>
                        </div>
                    </div>
                    ${llmAnalysis.executive_summary.summary ? `
                    <hr>
                    <div class="alert alert-light">
                        <h6><i class="fas fa-lightbulb me-2"></i>Key Insights</h6>
                        <p class="mb-0">${escapeHtml(llmAnalysis.executive_summary.summary)}</p>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    // Deep Technical Analysis - Simplified for candidates
    if (llmAnalysis.deep_technical_analysis) {
        const techAnalysis = llmAnalysis.deep_technical_analysis;
        
        html += `
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-code me-2"></i>Technical Skills Assessment</h6>
                </div>
                <div class="card-body">
        `;
        
        // Core Skills Assessment - Candidate-friendly view
        if (techAnalysis.core_skills && techAnalysis.core_skills.length > 0) {
            html += `
                <div class="mb-4">
                    <h6><i class="fas fa-cogs me-2"></i>Your Technical Skills</h6>
                    <div class="row">
            `;
            
            techAnalysis.core_skills.forEach(skill => {
                const verdictClass = getVerdictBadgeClass(skill.verdict);
                const evidenceClass = getEvidenceQualityClass(skill.evidence_quality);
                
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0">${escapeHtml(skill.skill || 'Unknown Skill')}</h6>
                                <span class="badge ${verdictClass}">${skill.verdict || 'N/A'}</span>
                            </div>
                            <div class="small mb-2">
                                <strong>Your Level:</strong> ${escapeHtml(skill.assessed_level || 'N/A')}
                            </div>
                            <div class="mb-2">
                                <span class="badge ${evidenceClass} small">Evidence Quality: ${skill.evidence_quality || 'N/A'}</span>
                            </div>
                            ${skill.depth_indicators && skill.depth_indicators.length > 0 ? `
                            <div class="small text-success mb-1">
                                <strong>Strengths:</strong> ${skill.depth_indicators.join(', ')}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += `</div></div>`;
        }
        
        // Code Quality Indicators
        if (techAnalysis.code_quality_indicators) {
            const quality = techAnalysis.code_quality_indicators;
            html += `
                <div class="mb-3">
                    <h6><i class="fas fa-check-circle me-2"></i>Professional Development Areas</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="border rounded p-3">
                                <strong>Testing & Quality:</strong> ${escapeHtml(quality.testing_practices || 'N/A')}<br>
                                <strong>Documentation:</strong> ${escapeHtml(quality.documentation_habits || 'N/A')}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-3">
                                <strong>Code Review:</strong> ${escapeHtml(quality.code_review_experience || 'N/A')}<br>
                                <strong>Best Practices:</strong> ${escapeHtml(quality.technical_debt_awareness || 'N/A')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        html += `</div></div>`;
    }
    
    // Development Roadmap - Candidate Focus
    if (llmAnalysis.development_roadmap) {
        const roadmap = llmAnalysis.development_roadmap;
        html += `
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="fas fa-road me-2"></i>Your Development Path</h6>
                </div>
                <div class="card-body">
        `;
        
        // Growth Potential
        if (roadmap.growth_potential) {
            const growth = roadmap.growth_potential;
            html += `
                <div class="mb-4">
                    <h6><i class="fas fa-chart-line me-2"></i>Growth Outlook</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="border rounded p-3 text-center">
                                <div class="h4 text-${getTrajectoryColor(growth.trajectory)}">${escapeHtml(growth.trajectory || 'N/A')}</div>
                                <small class="text-muted">Career Trajectory</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-3 text-center">
                                <div class="h5 text-info">${escapeHtml(growth.ceiling || 'N/A')}</div>
                                <small class="text-muted">Potential Level</small>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <p><strong>Learning Ability:</strong> ${escapeHtml(growth.learning_velocity || 'N/A')}</p>
                        <p><strong>Adaptability:</strong> ${escapeHtml(growth.adaptability || 'N/A')}</p>
                    </div>
                </div>
            `;
        }
        
        // Immediate Gaps - Presented as development opportunities
        if (roadmap.immediate_gaps && roadmap.immediate_gaps.length > 0) {
            html += `
                <div class="mb-3">
                    <h6><i class="fas fa-target me-2"></i>Development Opportunities</h6>
                    <div class="row">
            `;
            
            roadmap.immediate_gaps.slice(0, 4).forEach(gap => {
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3">
                            <h6 class="text-primary">${escapeHtml(gap.gap || 'Unknown Gap')}</h6>
                            <div class="small mb-2">
                                <strong>Impact:</strong> ${escapeHtml(gap.business_impact || 'N/A')}
                            </div>
                            <div class="small">
                                <strong>Time Investment:</strong> ${escapeHtml(gap.time_to_fill || 'N/A')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div></div>`;
        }
        
        html += `</div></div>`;
    }
    
    // Skill Verification - Positive focus for candidates
    if (llmAnalysis.skill_verification) {
        const verification = llmAnalysis.skill_verification;
        
        html += `
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Skill Validation</h6>
                </div>
                <div class="card-body">
        `;
        
        // Show verified skills
        if (verification.verified_skills && verification.verified_skills.length > 0) {
            html += `
                <div class="mb-3">
                    <h6><i class="fas fa-check-circle me-2 text-success"></i>Verified Skills</h6>
                    <div class="d-flex flex-wrap gap-2">
            `;
            
            verification.verified_skills.forEach(skill => {
                html += `<span class="badge bg-success">${escapeHtml(skill)}</span>`;
            });
            
            html += `</div></div>`;
        }
        
        // Show unverified skills as areas to strengthen
        if (verification.unverified_claims && verification.unverified_claims.length > 0) {
            html += `
                <div class="mb-3">
                    <h6><i class="fas fa-lightbulb me-2 text-warning"></i>Areas to Strengthen</h6>
                    <div class="d-flex flex-wrap gap-2">
            `;
            
            verification.unverified_claims.forEach(skill => {
                html += `<span class="badge bg-warning text-dark">${escapeHtml(skill)}</span>`;
            });
            
            html += `</div></div>`;
        }
        
        html += `</div></div>`;
    }
    
    // Fallback for old format or incomplete data
    if (!html || html.trim() === '') {
        // Try old format
        if (insights.technical_assessment || insights.skills_analysis || insights.strengths) {
            html = generateOldFormatHTML(insights);
        } else {
            html = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>Resume Analysis</h6>
                    <p class="mb-0">Your resume has been analyzed. The detailed insights may still be processing.</p>
                </div>
            `;
        }
    }
    
    return html;
}

// Helper function for old format compatibility
function generateOldFormatHTML(insights) {
    let html = '';
    
    // Technical Assessment Overview
    if (insights.technical_assessment) {
        const assessment = insights.technical_assessment;
        html += `
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Technical Assessment</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="display-4 text-primary">${assessment.overall_rating}/10</div>
                                <small class="text-muted">Overall Rating</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <div class="h4 text-success">${assessment.technical_strength}</div>
                                <small class="text-muted">Technical Level</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <p class="mb-0">${assessment.summary}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Skills Analysis
    if (insights.skills_analysis) {
        const skills = insights.skills_analysis;
        html += `
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-cogs me-2"></i>Skills Analysis</h6>
                </div>
                <div class="card-body">
                    <div class="row">
        `;
        
        // Technical Skills
        if (skills.technical_skills) {
            Object.keys(skills.technical_skills).forEach(category => {
                if (skills.technical_skills[category] && skills.technical_skills[category].length > 0) {
                    html += `
                        <div class="col-md-6 mb-3">
                            <h6>${category.replace(/_/g, ' ').toUpperCase()}</h6>
                            <div class="skill-list">
                    `;
                    skills.technical_skills[category].forEach(skill => {
                        const badgeClass = getProficiencyBadgeClass(skill.proficiency);
                        html += `
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>${skill.skill}</span>
                                <span class="badge ${badgeClass}">${skill.proficiency}</span>
                            </div>
                            <small class="text-muted d-block mb-2">${skill.evidence}</small>
                        `;
                    });
                    html += `</div></div>`;
                }
            });
        }
        
        html += `</div></div></div>`;
    }
    
    // Strengths and Recommendations
    if (insights.strengths || insights.recommendations) {
        html += `
            <div class="row">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-star me-2"></i>Key Strengths</h6>
                        </div>
                        <div class="card-body">
        `;
        
        if (insights.strengths) {
            insights.strengths.forEach(strength => {
                html += `
                    <div class="mb-3">
                        <strong>${strength.strength}</strong>
                        <p class="mb-1">${strength.evidence}</p>
                        <small class="text-success">${strength.market_value}</small>
                    </div>
                `;
            });
        }
        
        html += `
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Development Areas</h6>
                        </div>
                        <div class="card-body">
        `;
        
        if (insights.recommendations && insights.recommendations.immediate_improvements) {
            insights.recommendations.immediate_improvements.forEach(improvement => {
                const priorityClass = improvement.priority === 'High' ? 'info' : 
                                    improvement.priority === 'Medium' ? 'secondary' : 'light';
                html += `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <strong>${improvement.area}</strong>
                            <span class="badge bg-${priorityClass}">${improvement.priority}</span>
                        </div>
                        <p class="mb-0">${improvement.action}</p>
                    </div>
                `;
            });
        }
        
        html += `
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    return html;
}

function getProficiencyBadgeClass(proficiency) {
    switch (proficiency?.toLowerCase()) {
        case 'expert': return 'bg-success';
        case 'advanced': return 'bg-primary';
        case 'intermediate': return 'bg-warning';
        case 'beginner': return 'bg-secondary';
        default: return 'bg-info';
    }
}

function getScoreColor(level) {
    if (typeof level === 'string') {
        switch (level.toLowerCase()) {
            case 'senior': case 'expert': case 'lead': return 'success';
            case 'mid': case 'intermediate': case 'advanced': return 'primary';
            case 'junior': case 'beginner': return 'warning';
            default: return 'info';
        }
    }
    return 'info';
}

function getRecommendationColor(decision) {
    if (typeof decision === 'string') {
        switch (decision.toLowerCase()) {
            case 'strong yes': case 'yes': case 'high': return 'success';
            case 'maybe': case 'medium': return 'warning';
            case 'no': case 'strong no': case 'low': return 'danger';
            default: return 'info';
        }
    }
    return 'info';
}

function getRiskColor(level) {
    if (typeof level === 'string') {
        switch (level.toLowerCase()) {
            case 'low': return 'success';
            case 'medium': return 'warning';
            case 'high': case 'critical': return 'danger';
            default: return 'info';
        }
    }
    return 'info';
}

function getVerdictBadgeClass(verdict) {
    if (typeof verdict === 'string') {
        switch (verdict.toLowerCase()) {
            case 'expert': return 'bg-success';
            case 'proficient': return 'bg-primary';
            case 'competent': return 'bg-info';
            case 'novice': return 'bg-warning';
            case 'unproven': return 'bg-secondary';
            default: return 'bg-light text-dark';
        }
    }
    return 'bg-light text-dark';
}

function getEvidenceQualityClass(quality) {
    if (typeof quality === 'string') {
        switch (quality.toLowerCase()) {
            case 'strong': return 'bg-success';
            case 'moderate': return 'bg-primary';
            case 'weak': return 'bg-warning';
            case 'no evidence': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }
    return 'bg-secondary';
}

function getTrajectoryColor(trajectory) {
    if (typeof trajectory === 'string') {
        switch (trajectory.toLowerCase()) {
            case 'high-growth': return 'success';
            case 'steady': return 'primary';
            case 'stagnant': return 'warning';
            case 'declining': return 'danger';
            default: return 'info';
        }
    }
    return 'info';
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function downloadInsightsReport(insights) {
    // Create a formatted text report
    let report = "RESUME INSIGHTS REPORT\n";
    report += "=".repeat(50) + "\n\n";
    
    if (insights.technical_assessment) {
        report += "TECHNICAL ASSESSMENT\n";
        report += "-".repeat(20) + "\n";
        report += `Overall Rating: ${insights.technical_assessment.overall_rating}/10\n`;
        report += `Technical Strength: ${insights.technical_assessment.technical_strength}\n`;
        report += `Summary: ${insights.technical_assessment.summary}\n\n`;
    }
    
    if (insights.strengths) {
        report += "KEY STRENGTHS\n";
        report += "-".repeat(20) + "\n";
        insights.strengths.forEach((strength, index) => {
            report += `${index + 1}. ${strength.strength}\n`;
            report += `   Evidence: ${strength.evidence}\n`;
            report += `   Market Value: ${strength.market_value}\n\n`;
        });
    }
    
    if (insights.recommendations && insights.recommendations.immediate_improvements) {
        report += "RECOMMENDATIONS\n";
        report += "-".repeat(20) + "\n";
        insights.recommendations.immediate_improvements.forEach((rec, index) => {
            report += `${index + 1}. ${rec.area} (${rec.priority} Priority)\n`;
            report += `   Action: ${rec.action}\n\n`;
        });
    }
    
    report += `\nGenerated on: ${new Date().toLocaleString()}\n`;
    report += "Generated by: AI-Powered ATS Resume Insights\n";
    
    // Create and download file
    const blob = new Blob([report], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `resume_insights_${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    showAlert('Insights report downloaded successfully!', 'success');
}

// Load interview count for candidates
async function loadInterviewCount() {
    try {
        const response = await fetch('/api/interviews/candidate/count', {
            headers: getAuthHeaders()
        });
        
        if (response.ok) {
            const data = await response.json();
            updateStatElement('interviewCount', data.count || 0);
        } else {
            console.error('Failed to load interview count');
            updateStatElement('interviewCount', 0);
        }
    } catch (error) {
        console.error('Error loading interview count:', error);
        updateStatElement('interviewCount', 0);
    }
}

// View candidate interviews
async function viewCandidateInterviews() {
    try {
        showAlert('Loading your interviews...', 'info');
        
        const response = await fetch('/api/interviews/candidate', {
            headers: getAuthHeaders()
        });
        
        if (response.ok) {
            const data = await response.json();
            showCandidateInterviewsModal(data.interviews || []);
        } else {
            throw new Error('Failed to load interviews');
        }
    } catch (error) {
        console.error('Error loading interviews:', error);
        showAlert('Could not load interviews', 'danger');
    }
}

function showCandidateInterviewsModal(interviews) {
    const modalHtml = `
        <div class="modal fade" id="candidateInterviewsModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-calendar-alt me-2"></i>My Interviews
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${interviews.length > 0 ? `
                            <div class="row">
                                ${interviews.map(interview => {
                                    const isToday = new Date(interview.scheduled_at).toDateString() === new Date().toDateString();
                                    const isUpcoming = new Date(interview.scheduled_at) > new Date();
                                    const cardClass = isToday ? 'interview-today' : (isUpcoming ? 'interview-upcoming' : '');
                                    
                                    return `
                                    <div class="col-md-6 mb-3">
                                        <div class="card h-100 interview-card ${cardClass} ${getInterviewCardClass(interview.status)}">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0">${interview.title}</h6>
                                                <div>
                                                    ${isToday ? '<span class="badge bg-warning me-1">Today</span>' : ''}
                                                    <span class="badge bg-${getInterviewStatusColor(interview.status)}">
                                                        ${interview.status}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <p><strong>Position:</strong> ${interview.job_title || 'N/A'}</p>
                                                <p><strong>Company:</strong> ${interview.company || 'N/A'}</p>
                                                <p><strong>Type:</strong> 
                                                    <span class="badge bg-secondary">${interview.interview_type}</span>
                                                </p>
                                                <p><strong>Date & Time:</strong><br>
                                                    <span class="${isToday ? 'text-warning fw-bold' : isUpcoming ? 'text-success' : 'text-muted'}">
                                                        ${new Date(interview.scheduled_at).toLocaleDateString()} at 
                                                        ${new Date(interview.scheduled_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                                    </span>
                                                </p>
                                                <p><strong>Duration:</strong> ${interview.duration_minutes} minutes</p>
                                                ${interview.location ? `<p><strong>Location:</strong> ${interview.location}</p>` : ''}
                                                ${interview.meeting_link ? `
                                                    <p><strong>Meeting Link:</strong><br>
                                                        <a href="${interview.meeting_link}" target="_blank" class="btn btn-sm btn-primary">
                                                            <i class="fas fa-video me-1"></i>Join Meeting
                                                        </a>
                                                    </p>
                                                ` : ''}
                                                ${interview.description ? `<p><strong>Description:</strong><br>${interview.description}</p>` : ''}
                                            </div>
                                            <div class="card-footer d-flex justify-content-between align-items-center">
                                                <small class="text-muted">
                                                    Scheduled ${timeAgo(interview.created_at)}
                                                </small>
                                                ${interview.status === 'scheduled' && new Date(interview.scheduled_at) > new Date() ? `
                                                    <button class="btn btn-sm btn-outline-primary" onclick="addToCalendar(${interview.id})">
                                                        <i class="fas fa-calendar-plus"></i>
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                        ` : `
                            <div class="text-center py-5">
                                <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No Interviews Scheduled</h5>
                                <p class="text-muted">You don't have any interviews scheduled yet.</p>
                            </div>
                        `}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('candidateInterviewsModal');
    if (existingModal) existingModal.remove();
    
    // Add new modal
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('candidateInterviewsModal'));
    modal.show();
}

function getInterviewStatusColor(status) {
    switch (status?.toLowerCase()) {
        case 'scheduled': return 'primary';
        case 'completed': return 'success';
        case 'cancelled': return 'danger';
        case 'rescheduled': return 'warning';
        default: return 'secondary';
    }
}

function getInterviewCardClass(status) {
    switch (status?.toLowerCase()) {
        case 'scheduled': return 'border-primary';
        case 'completed': return 'border-success';
        case 'cancelled': return 'border-danger';
        case 'rescheduled': return 'border-warning';
        default: return '';
    }
}

function addToCalendar(interviewId) {
    showAlert('Calendar integration coming soon!', 'info');
}

function timeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 1) return 'yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    if (diffDays < 30) return `${Math.ceil(diffDays / 7)} weeks ago`;
    return `${Math.ceil(diffDays / 30)} months ago`;
}

function showInterviewNotificationModal(interview) {
    const modalHtml = `
        <div class="modal fade" id="interviewNotificationModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-calendar-alt me-2"></i>Interview Scheduled!
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-3">
                            <i class="fas fa-handshake fa-3x text-success mb-2"></i>
                            <h6>Great news! You have been scheduled for an interview.</h6>
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">${interview.title}</h6>
                                <p><strong>Position:</strong> ${interview.job_title || 'N/A'}</p>
                                <p><strong>Company:</strong> ${interview.company || 'N/A'}</p>
                                <p><strong>Type:</strong> 
                                    <span class="badge bg-secondary">${interview.interview_type}</span>
                                </p>
                                <p><strong>Date & Time:</strong><br>
                                    <span class="text-primary fw-bold">
                                        ${new Date(interview.scheduled_at).toLocaleDateString()} at 
                                        ${new Date(interview.scheduled_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                    </span>
                                </p>
                                <p><strong>Duration:</strong> ${interview.duration_minutes} minutes</p>
                                ${interview.location ? `<p><strong>Location:</strong> ${interview.location}</p>` : ''}
                                ${interview.meeting_link ? `
                                    <p><strong>Meeting Link:</strong><br>
                                        <a href="${interview.meeting_link}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-video me-1"></i>Join Meeting
                                        </a>
                                    </p>
                                ` : ''}
                                ${interview.description ? `<p><strong>Description:</strong><br>${interview.description}</p>` : ''}
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Tips:</strong> Prepare for your interview by reviewing the job description and researching the company. Good luck!
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="viewCandidateInterviews(); bootstrap.Modal.getInstance(document.getElementById('interviewNotificationModal')).hide();">
                            <i class="fas fa-calendar me-1"></i>View All Interviews
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('interviewNotificationModal');
    if (existingModal) existingModal.remove();
    
    // Add new modal
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('interviewNotificationModal'));
    modal.show();
}

// Job Match Analysis Functions
async function viewApplicationWithAnalysis(applicationId) {
    try {
        showAlert('Loading application details...', 'info');
        
        // First get the application details
        const response = await fetch(`/api/jobs/applications/${applicationId}`, {
            headers: getAuthHeaders()
        });
        
        if (!response.ok) {
            throw new Error('Could not load application details');
        }
        
        const application = await response.json();
        
        // Then get the match analysis
        const analysisResponse = await fetch(`/api/jobs/applications/${applicationId}/match-analysis`, {
            headers: getAuthHeaders()
        });
        
        let analysis = null;
        if (analysisResponse.ok) {
            const analysisData = await analysisResponse.json();
            analysis = analysisData.analysis;
        }
        
        showApplicationDetailsWithAnalysis(application, analysis);
        
    } catch (error) {
        console.error('Error viewing application:', error);
        showAlert('Could not load application details', 'danger');
    }
}

async function analyzeApplicationMatch(applicationId) {
    try {
        showAlert('Analyzing job match...', 'info', 0);
        
        const response = await fetch(`/api/jobs/applications/${applicationId}/match-analysis`, {
            headers: getAuthHeaders()
        });
        
        if (!response.ok) {
            throw new Error('Failed to analyze match');
        }
        
        const data = await response.json();
        showAlert('Match analysis completed!', 'success');
        
        // Refresh the dashboard to show updated match scores
        loadDashboardData();
        
        // Show the analysis
        viewApplicationWithAnalysis(applicationId);
        
    } catch (error) {
        console.error('Error analyzing match:', error);
        showAlert('Failed to analyze job match', 'danger');
    }
}

function showApplicationDetailsWithAnalysis(application, analysis) {
    // Create modal for application details if it doesn't exist
    let modal = document.getElementById('applicationDetailModal');
    
    if (!modal) {
        const modalHtml = `
            <div class="modal fade" id="applicationDetailModal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Application Details & Match Analysis</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="applicationDetailContent">
                            <!-- Content will be populated dynamically -->
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-danger" id="withdrawApplicationBtn" onclick="withdrawApplication(currentApplicationId)">
                                Withdraw Application
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        modal = document.getElementById('applicationDetailModal');
    }
    
    // Store current application ID
    window.currentApplicationId = application.id;
    
    // Generate content with analysis
    const content = document.getElementById('applicationDetailContent');
    content.innerHTML = generateApplicationDetailsHTML(application, analysis);
    
    // Show withdraw button only if application is not already withdrawn
    const withdrawBtn = document.getElementById('withdrawApplicationBtn');
    withdrawBtn.style.display = ['withdrawn', 'rejected', 'hired'].includes(application.status?.toLowerCase()) ? 'none' : 'block';
    
    // Show the modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

function generateApplicationDetailsHTML(application, analysis) {
    if (!analysis) {
        return generateBasicApplicationHTML(application);
    }
    
    const matchScore = analysis.overall_match_score || 0;
    const matchColor = matchScore >= 80 ? 'success' : matchScore >= 60 ? 'warning' : 'danger';
    
    return `
        <div class="row">
            <!-- Application Overview -->
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">Application Details</h6>
                        <p><strong>Company:</strong> ${application.job?.company || 'Unknown'}</p>
                        <p><strong>Position:</strong> ${application.job?.title || 'Unknown'}</p>
                        <p><strong>Status:</strong> 
                            <span class="badge bg-${getStatusColor(application.status)}">
                                ${application.status || 'pending'}
                            </span>
                        </p>
                        <p><strong>Applied:</strong> ${new Date(application.created_at).toLocaleDateString()}</p>
                        <p><strong>Resume:</strong> ${application.resume?.filename || 'Unknown'}</p>
                    </div>
                </div>
            </div>
            
            <!-- Match Score Overview -->
            <div class="col-md-8 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title">Match Analysis Overview</h6>
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <div class="badge bg-primary fs-6 p-2 w-100">
                                    ${matchScore}%
                                </div>
                                <small class="text-muted d-block mt-1">Overall Match</small>
                            </div>
                            <div class="col-6">
                                <div class="badge bg-success fs-6 p-2 w-100">
                                    ${analysis.skill_match_score || 0}%
                                </div>
                                <small class="text-muted d-block mt-1">Skills</small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="progress">
                                <div class="progress-bar bg-${matchColor}" style="width: ${matchScore}%"></div>
                            </div>
                            <small class="text-muted">Fit Assessment: ${analysis.fit_assessment || 'Unknown'}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Matching Skills -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title text-success">
                            <i class="fas fa-check-circle me-2"></i>Matching Skills
                        </h6>
                        ${analysis.matching_skills && analysis.matching_skills.length > 0 ? 
                            `<div class="d-flex flex-wrap gap-1">
                                ${analysis.matching_skills.map(skill => 
                                    `<span class="badge bg-success">${skill}</span>`
                                ).join('')}
                            </div>` : 
                            '<p class="text-muted">No matching skills identified</p>'
                        }
                    </div>
                </div>
            </div>
            
            <!-- Missing Skills -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title text-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>Missing Skills
                        </h6>
                        ${analysis.missing_skills && analysis.missing_skills.length > 0 ? 
                            `<div class="d-flex flex-wrap gap-1">
                                ${analysis.missing_skills.map(skill => 
                                    `<span class="badge bg-warning text-dark">${skill}</span>`
                                ).join('')}
                            </div>` : 
                            '<p class="text-muted">No missing skills found</p>'
                        }
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Strengths -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title text-success">
                            <i class="fas fa-thumbs-up me-2"></i>Strengths
                        </h6>
                        ${analysis.strengths && analysis.strengths.length > 0 ? 
                            `<ul class="list-unstyled">
                                ${analysis.strengths.map(strength => 
                                    `<li><i class="fas fa-plus text-success me-2"></i>${strength}</li>`
                                ).join('')}
                            </ul>` : 
                            '<p class="text-muted">No specific strengths identified</p>'
                        }
                    </div>
                </div>
            </div>
            
            <!-- Recommendations -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title text-info">
                            <i class="fas fa-lightbulb me-2"></i>Recommendations
                        </h6>
                        ${analysis.recommendations && analysis.recommendations.length > 0 ? 
                            `<ul class="list-unstyled">
                                ${analysis.recommendations.map(rec => 
                                    `<li><i class="fas fa-arrow-right text-info me-2"></i>${rec}</li>`
                                ).join('')}
                            </ul>` : 
                            '<p class="text-muted">No specific recommendations</p>'
                        }
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Detailed Analysis -->
        ${analysis.detailed_analysis ? `
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Detailed Analysis</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Skills Analysis:</h6>
                            <p class="small">${analysis.detailed_analysis.skills_analysis || 'No analysis available'}</p>
                            
                            <h6>Experience Analysis:</h6>
                            <p class="small">${analysis.detailed_analysis.experience_analysis || 'No analysis available'}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Culture Fit:</h6>
                            <p class="small">${analysis.detailed_analysis.culture_fit || 'No assessment available'}</p>
                            
                            <h6>Growth Potential:</h6>
                            <p class="small">${analysis.detailed_analysis.growth_potential || 'No assessment available'}</p>
                        </div>
                    </div>
                </div>
            </div>
        ` : ''}
        
        <!-- Summary -->
        <div class="alert alert-info mt-3">
            <h6><i class="fas fa-info-circle me-2"></i>Summary</h6>
            <p class="mb-0">${analysis.summary || 'No summary available'}</p>
        </div>
    `;
}

function generateBasicApplicationHTML(application) {
        const matchScore = typeof application.match_score === 'number' ? 
            Math.round(application.match_score * 100) : 'N/A';
        
        return `
            <div class="row mb-4">
                <div class="col-md-8">
                    <h4>${application.job_title || 'Unknown Job'}</h4>
                    <h6 class="text-muted">${application.company || 'Unknown Company'}</h6>
                </div>
                <div class="col-md-4 text-end">
                    <div class="badge bg-${getStatusColor(application.status)} fs-5">${application.status || 'Pending'}</div>
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">Application Details</div>
                        <div class="card-body">
                            <p><strong>Applied on:</strong> ${new Date(application.applied_at).toLocaleDateString()}</p>
                            <p><strong>Status:</strong> ${application.status || 'Pending'}</p>
                            <p><strong>Match Score:</strong> ${matchScore}%</p>
                            ${application.feedback ? `<p><strong>Feedback:</strong> ${application.feedback}</p>` : ''}
                            ${application.interview_date ? 
                                `<p><strong>Interview Date:</strong> ${new Date(application.interview_date).toLocaleString()}</p>` : ''}
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">Resume Used</div>
                        <div class="card-body">
                            <p><strong>Resume:</strong> ${application.resume_name || 'Unknown'}</p>
                            ${application.cover_letter ? 
                                `<div class="mt-3">
                                    <strong>Cover Letter:</strong>
                                    <div class="border rounded p-2 mt-1 bg-light">${application.cover_letter}</div>
                                </div>` : 
                                '<p>No cover letter submitted</p>'}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-warning">
                <i class="fas fa-chart-line me-2"></i>
                <strong>Match analysis not available.</strong> Click "Analyze Match" to generate detailed analysis for this application.
                <button class="btn btn-sm btn-primary ms-2" onclick="analyzeApplicationMatch(${application.id})">
                    Analyze Match
                </button>
            </div>
        `;
    }

    // Additional helper functions
    function showAnalytics() {
        showAlert('Advanced analytics feature coming soon!', 'info');
    }

    function findQuickMatches() {
        showAlert('Finding quick job matches...', 'info');
        // This could redirect to the jobs page with filters applied
        window.location.href = '/dashboard/jobs';
    }

    function viewResume(resumeId) {
        if (!resumeId) {
            showAlert('Resume not available', 'warning');
            return;
        }
        
        // Open resume in new tab
        const token = localStorage.getItem('token');
        const url = `/api/resumes/${resumeId}/download?token=${encodeURIComponent(token)}`;
        window.open(url, '_blank');
    }

    // Show insights options modal
    async function showInsightsOptions() {
        try {
            // Get user's resumes first
            const token = localStorage.getItem('token');
            const response = await fetch('/api/resumes/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            const data = await response.json();
            
            if (!data.resumes || data.resumes.length === 0) {
                showAlert('Please upload a resume first to get insights.', 'warning');
                return;
            }
            
            // Create modal with resume selection
            const modalHtml = `
                <div class="modal fade" id="insightsOptionsModal" tabindex="-1" aria-labelledby="insightsOptionsModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="insightsOptionsModalLabel">
                                    <i class="fas fa-brain me-2"></i>Get Resume Insights
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <h6 class="mb-3">Select a resume to analyze:</h6>
                                <div class="row">
                                    ${data.resumes.map(resume => `
                                        <div class="col-md-6 mb-3">
                                            <div class="card insights-option-card h-100" onclick="selectResumeForInsights(${resume.id}, '${resume.filename}')">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-file-alt fa-2x mb-2 text-primary"></i>
                                                    <h6>${resume.filename}</h6>
                                                    <small class="text-muted">
                                                        ${resume.skills ? resume.skills.length : 0} skills detected<br>
                                                        Uploaded: ${new Date(resume.created_at).toLocaleDateString()}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <hr>
                                
                                <h6 class="mb-3">Available Insights:</h6>
                                <div class="row">
                                    <div class="col-md-4 mb-2">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-chart-line me-2 text-success"></i>
                                            <span>Technical Assessment</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-cogs me-2 text-info"></i>
                                            <span>Skills Analysis</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-briefcase me-2 text-warning"></i>
                                            <span>Experience Evaluation</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-graduation-cap me-2 text-primary"></i>
                                            <span>Education Assessment</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-lightbulb me-2 text-danger"></i>
                                            <span>Career Recommendations</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-chart-bar me-2 text-secondary"></i>
                                            <span>Market Positioning</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('insightsOptionsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('insightsOptionsModal'));
            modal.show();
            
        } catch (error) {
            console.error('Error loading resumes for insights:', error);
            showAlert('Could not load resumes. Please try again.', 'danger');
        }
    }

    function selectResumeForInsights(resumeId, filename) {
        // Close the options modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('insightsOptionsModal'));
        modal.hide();
        
        // Show confirmation and start insights generation
        showAlert(`Generating insights for "${filename}"...`, 'info', 0);
        
        // Generate insights
        setTimeout(() => {
            getResumeInsights(resumeId);
        }, 500);
    }

    // GitHub Analysis Functions
    let githubAnalysisData = null;
    let githubRepos = [];  // Store GitHub repositories
    let selectedRepos = []; // Store selected repository IDs

    async function showGitHubAnalysis() {
        try {
            // Check if user is authenticated
            const token = localStorage.getItem('token');
            if (!token) {
                showAlert('Please log in to access GitHub analysis.', 'warning');
                return;
            }

            // Show loading state
            const btn = document.getElementById('githubAnalysisBtn');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Connecting...';
            btn.disabled = true;

            // Check if user has GitHub connected and get repos
            const checkResponse = await fetch('/api/github/repos', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (checkResponse.status === 401) {
                const errorData = await checkResponse.json();
                if (errorData.github_login_url) {
                    // User needs to connect GitHub account
                    showAlert('Please connect your GitHub account first.', 'info');
                    
                    // Reset button and redirect to GitHub login
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                    
                    // Open GitHub login in current tab
                    window.location.href = errorData.github_login_url + '?redirect_to_frontend=true';
                    return;
                }
            } else if (checkResponse.ok) {
                // User has GitHub connected, show analysis modal
                showGitHubAnalysisModal();
            } else {
                throw new Error('Failed to check GitHub connection');
            }

            // Reset button
            btn.innerHTML = originalContent;
            btn.disabled = false;

        } catch (error) {
            console.error('GitHub analysis error:', error);
            showAlert('Failed to connect to GitHub. Please try again.', 'error');
            
            // Reset button
            const btn = document.getElementById('githubAnalysisBtn');
            btn.innerHTML = '<i class="fas fa-code me-2"></i>Analyze Code';
            btn.disabled = false;
        }
    }

    async function showGitHubAnalysisModal() {
        const modalHtml = `
            <div class="modal fade" id="githubAnalysisModal" tabindex="-1" aria-labelledby="githubAnalysisModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="githubAnalysisModalLabel">
                                <i class="fab fa-github me-2"></i>GitHub Repository Analysis
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="text-center" id="githubRepoLoading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-3">Loading your GitHub repositories...</p>
                            </div>
                            <div id="githubRepoSelection" style="display: none;"></div>
                            <div id="githubAnalysisContent" style="display: none;"></div>
                        </div>
                        <div class="modal-footer d-flex justify-content-between">
                            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                            <div id="repoSelectionButtons" style="display: none;">
                                <button type="button" class="btn btn-success me-2" onclick="analyzeSelectedRepos()" disabled>
                                    <i class="fas fa-check-circle me-2"></i>Analyze Selected
                                </button>
                                <button type="button" class="btn btn-primary" onclick="analyzeAllRepos()">
                                    <i class="fas fa-code-branch me-2"></i>Analyze All Combined
                                </button>
                            </div>
                            <button type="button" class="btn btn-outline-primary" onclick="showRepoSelection()" id="backToSelectionBtn" style="display: none;">
                                <i class="fas fa-arrow-left me-2"></i>Back to Selection
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal if present
        const existingModal = document.getElementById('githubAnalysisModal');
        if (existingModal) {
            existingModal.remove();
        }

        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('githubAnalysisModal'));
        modal.show();

        // Load repositories
        await loadGitHubRepositories();
    }

    // Load repositories from GitHub
    async function loadGitHubRepositories() {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/github/repos', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!response.ok) {
                throw new Error('Failed to load repositories');
            }
            
            const data = await response.json();
            // Use repositories key based on the backend implementation
            githubRepos = data.repositories || [];
            
            showRepoSelection();
            
        } catch (error) {
            console.error('Error loading repositories:', error);
            document.getElementById('githubRepoLoading').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Failed to load repositories: ${error.message}
                </div>
                <button class="btn btn-primary" onclick="loadGitHubRepositories()">
                    <i class="fas fa-sync-alt me-2"></i>Try Again
                </button>
            `;
        }
    }
    
    // Display repository selection UI
    function showRepoSelection() {
        const repoLoadingDiv = document.getElementById('githubRepoLoading');
        const repoSelectionDiv = document.getElementById('githubRepoSelection');
        const analysisContentDiv = document.getElementById('githubAnalysisContent');
        const repoSelectionButtons = document.getElementById('repoSelectionButtons');
        const backToSelectionBtn = document.getElementById('backToSelectionBtn');
        
        // Update visibility
        repoLoadingDiv.style.display = 'none';
        repoSelectionDiv.style.display = 'block';
        analysisContentDiv.style.display = 'none';
        repoSelectionButtons.style.display = 'block';
        backToSelectionBtn.style.display = 'none';
        
        // Generate repo selection HTML
        let repoSelectionHtml = `
            <h4 class="mb-2">Select repositories to analyze</h4>
            <p class="text-muted mb-4">Choose specific repositories for individual analysis or select multiple for combined analysis.</p>
            
            <div class="mb-4">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAllRepos" onchange="toggleAllRepos()">
                    <label class="form-check-label" for="selectAllRepos">
                        <strong>Select All Repositories</strong>
                    </label>
                </div>
            </div>
            
            <div class="row">
        `;
        
        if (githubRepos.length > 0) {
            githubRepos.forEach(repo => {
                // Extract stars count from repository data
                const starsCount = repo.stargazers_count || repo.stars || 0;
                
                repoSelectionHtml += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="form-check mb-2">
                                    <input class="form-check-input repo-checkbox" type="checkbox" value="${repo.id}" 
                                           id="repo${repo.id}" data-repo-name="${repo.name}" onchange="updateSelectedRepos()">
                                    <label class="form-check-label" for="repo${repo.id}">
                                        <strong>${repo.name}</strong>
                                    </label>
                                </div>
                                <p class="card-text small text-muted mb-2">${repo.description || 'No description available'}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <span class="badge bg-light text-dark me-1">
                                            <i class="fas fa-code me-1"></i>${repo.language || 'Unknown'}
                                        </span>
                                        <span class="badge bg-light text-dark">
                                            <i class="fas fa-star me-1"></i>${starsCount}
                                        </span>
                                    </small>
                                    <button class="btn btn-sm btn-outline-primary" onclick="analyzeRepo('${repo.id}', '${repo.name}')">
                                        Analyze This
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        } else {
            repoSelectionHtml += `
                <div class="col-12">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No repositories found. Please make sure your GitHub account has public repositories.
                    </div>
                </div>
            `;
        }
        
        repoSelectionHtml += `</div>`;
        repoSelectionDiv.innerHTML = repoSelectionHtml;
        
        // Initialize selected repos state
        updateSelectedRepos();
    }
    
    // Toggle all repositories selection
    function toggleAllRepos() {
        const selectAllCheckbox = document.getElementById('selectAllRepos');
        const repoCheckboxes = document.querySelectorAll('.repo-checkbox');
        
        repoCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
        
        updateSelectedRepos();
    }
    
    // Update selected repos array based on checkboxes
    function updateSelectedRepos() {
        selectedRepos = [];
        const repoCheckboxes = document.querySelectorAll('.repo-checkbox:checked');
        
        repoCheckboxes.forEach(checkbox => {
            selectedRepos.push({
                id: checkbox.value,
                name: checkbox.getAttribute('data-repo-name')
            });
        });
        
        // Update UI based on selection
        const analyzeSelectedBtn = document.querySelector('.btn-success');
        if (analyzeSelectedBtn) {
            analyzeSelectedBtn.disabled = selectedRepos.length === 0;
        }
    }
    
    // Analyze a single repository
    async function analyzeRepo(repoId, repoName) {
        showRepoAnalysisLoading(repoName);
        
        try {
            const token = localStorage.getItem('token');
            // Use the single analyze endpoint with filter parameter
            const response = await fetch(`/api/github/analyze`, {
                method: 'POST',
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ repo_filter: repoId }) // Send repo ID as filter parameter
            });
            
            if (!response.ok) {
                throw new Error(`Failed to analyze repository: ${repoName}`);
            }
            
            const data = await response.json();
            githubAnalysisData = data;
            displayGitHubAnalysis(data);
            
            // Show back to selection button
            document.getElementById('repoSelectionButtons').style.display = 'none';
            document.getElementById('backToSelectionBtn').style.display = 'inline-block';
            
        } catch (error) {
            console.error('Repository analysis error:', error);
            document.getElementById('githubAnalysisContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Analysis failed: ${error.message}
                </div>
                <button class="btn btn-primary" onclick="analyzeRepo('${repoId}', '${repoName}')">
                    <i class="fas fa-sync-alt me-2"></i>Try Again
                </button>
            `;
            document.getElementById('githubAnalysisContent').style.display = 'block';
            document.getElementById('githubRepoLoading').style.display = 'none';
        }
    }
    
    // Analyze selected repositories
    async function analyzeSelectedRepos() {
        if (selectedRepos.length === 0) {
            showAlert('Please select at least one repository to analyze', 'warning');
            return;
        }
        
        const repoNames = selectedRepos.map(repo => repo.name).join(", ");
        const repoIds = selectedRepos.map(repo => repo.id);
        
        showRepoAnalysisLoading(`Selected Repositories: ${repoNames}`);
        
        try {
            const token = localStorage.getItem('token');
            // Use the main analyze endpoint with repo_ids filter parameter
            const response = await fetch('/api/github/analyze', {
                method: 'POST',
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ repo_ids: repoIds })
            });
            
            if (!response.ok) {
                throw new Error('Failed to analyze selected repositories');
            }
            
            const data = await response.json();
            githubAnalysisData = data;
            displayGitHubAnalysis(data);
            
            // Show back to selection button
            document.getElementById('repoSelectionButtons').style.display = 'none';
            document.getElementById('backToSelectionBtn').style.display = 'inline-block';
            
        } catch (error) {
            console.error('Multiple repository analysis error:', error);
            document.getElementById('githubAnalysisContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Analysis failed: ${error.message}
                </div>
                <button class="btn btn-primary" onclick="analyzeSelectedRepos()">
                    <i class="fas fa-sync-alt me-2"></i>Try Again
                </button>
            `;
            document.getElementById('githubAnalysisContent').style.display = 'block';
            document.getElementById('githubRepoLoading').style.display = 'none';
        }
    }
    
    // Analyze all repositories together
    async function analyzeAllRepos() {
        showRepoAnalysisLoading('All Repositories Combined');
        
        try {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/github/analyze', {
                method: 'POST',
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error('Failed to analyze all repositories');
            }
            
            const data = await response.json();
            githubAnalysisData = data;
            displayGitHubAnalysis(data);
            
            // Show back to selection button
            document.getElementById('repoSelectionButtons').style.display = 'none';
            document.getElementById('backToSelectionBtn').style.display = 'inline-block';
            
        } catch (error) {
            console.error('All repository analysis error:', error);
            document.getElementById('githubAnalysisContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Analysis failed: ${error.message}
                </div>
                <button class="btn btn-primary" onclick="analyzeAllRepos()">
                    <i class="fas fa-sync-alt me-2"></i>Try Again
                </button>
            `;
            document.getElementById('githubAnalysisContent').style.display = 'block';
            document.getElementById('githubRepoLoading').style.display = 'none';
        }
    }
    
    // Show loading state for repository analysis
    function showRepoAnalysisLoading(repoName) {
        const repoLoadingDiv = document.getElementById('githubRepoLoading');
        const repoSelectionDiv = document.getElementById('githubRepoSelection');
        const analysisContentDiv = document.getElementById('githubAnalysisContent');
        
        repoLoadingDiv.style.display = 'block';
        repoSelectionDiv.style.display = 'none';
        analysisContentDiv.style.display = 'none';
        
        repoLoadingDiv.innerHTML = `
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Analyzing ${repoName}...</p>
            <p class="text-muted small">This may take a minute depending on repository size.</p>
        `;
    }
    
    // Display GitHub Analysis Results
    function displayGitHubAnalysis(data) {
        const repoLoadingDiv = document.getElementById('githubRepoLoading');
        const repoSelectionDiv = document.getElementById('githubRepoSelection');
        const analysisContentDiv = document.getElementById('githubAnalysisContent');
        
        // Hide loading and selection, show analysis
        repoLoadingDiv.style.display = 'none';
        repoSelectionDiv.style.display = 'none';
        analysisContentDiv.style.display = 'block';
        
        // Generate analysis HTML
        let analysisHtml = '';
        
        // Overall Assessment Section
        if (data.overall_assessment) {
            const assessment = data.overall_assessment;
            analysisHtml += `
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-user-code me-2"></i>Overall GitHub Profile Assessment</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Developer Level</h6>
                                <span class="badge bg-${getSkillLevelColor(assessment.developer_level)} fs-6">
                                    ${assessment.developer_level || 'Not specified'}
                                </span>
                                <h6 class="mt-3">Overall Rating</h6>
                                <span class="badge bg-${getRatingColor(assessment.overall_rating)} fs-6">
                                    ${assessment.overall_rating || 'Not specified'}
                                </span>
                            </div>
                            <div class="col-md-6">
                                <h6>Employability Score</h6>
                                <div class="progress mb-2">
                                    <div class="progress-bar bg-${getScoreColor(assessment.employability_score)}" 
                                         style="width: ${assessment.employability_score || 0}%">
                                        ${assessment.employability_score || 0}/100
                                    </div>
                                </div>
                                <h6>Innovation Factor</h6>
                                <div class="progress">
                                    <div class="progress-bar bg-warning" 
                                         style="width: ${(assessment.innovation_factor || 0) * 10}%">
                                        ${assessment.innovation_factor || 0}/10
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${assessment.portfolio_summary ? `
                            <div class="mt-3">
                                <h6>Portfolio Summary</h6>
                                <p class="text-muted">${assessment.portfolio_summary}</p>
                            </div>
                        ` : ''}
                        
                        <div class="row mt-3">
                            ${assessment.technical_strengths ? `
                                <div class="col-md-6">
                                    <h6>Technical Strengths</h6>
                                    <ul class="list-unstyled">
                                        ${assessment.technical_strengths.map(strength => `
                                            <li><i class="fas fa-check-circle text-success me-2"></i>${strength}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${assessment.areas_for_improvement ? `
                                <div class="col-md-6">
                                    <h6>Areas for Improvement</h6>
                                    <ul class="list-unstyled">
                                        ${assessment.areas_for_improvement.map(area => `
                                            <li><i class="fas fa-arrow-up text-warning me-2"></i>${area}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${assessment.recommended_roles ? `
                            <div class="mt-3">
                                <h6>Recommended Roles</h6>
                                <div>
                                    ${assessment.recommended_roles.map(role => `
                                        <span class="badge bg-info me-2">${role}</span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${assessment.hiring_recommendation ? `
                            <div class="mt-3">
                                <h6>Hiring Recommendation</h6>
                                <span class="badge bg-${getHiringRecommendationColor(assessment.hiring_recommendation)} fs-6">
                                    ${assessment.hiring_recommendation.replace('_', ' ').toUpperCase()}
                                </span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        // Repository Analyses Section
        if (data.repo_analyses && data.repo_analyses.length > 0) {
            analysisHtml += `
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-code-branch me-2"></i>
                            Repository Analysis (${data.repo_analyses.length} repositories)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
            `;
            
            data.repo_analyses.forEach(repoAnalysis => {
                const repo = repoAnalysis.repo_data;
                const analysis = repoAnalysis.analysis;
                
                analysisHtml += `
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">${repo.name}</h6>
                                <span class="badge bg-${getQualityColor(analysis.project_quality)}">
                                    ${analysis.project_quality || 'Unknown'}
                                </span>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-2">${repo.description || 'No description'}</p>
                                
                                <div class="row mb-2">
                                    <div class="col-6">
                                        <small><strong>Language:</strong> ${repo.language || 'N/A'}</small>
                                    </div>
                                    <div class="col-6">
                                        <small><strong>Stars:</strong> ${repo.stargazers_count || 0}</small>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small><strong>Complexity:</strong></small><br>
                                        <span class="badge bg-secondary">${analysis.complexity_level || 'Unknown'}</span>
                                    </div>
                                    <div class="col-6">
                                        <small><strong>Innovation:</strong></small><br>
                                        <span class="badge bg-warning">${analysis.innovation_score || 'N/A'}/10</span>
                                    </div>
                                </div>
                                
                                ${analysis.strengths ? `
                                    <div class="mb-2">
                                        <small><strong>Strengths:</strong></small>
                                        <ul class="small mb-0">
                                            ${analysis.strengths.slice(0, 2).map(strength => `<li>${strength}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                
                                ${analysis.overall_verdict ? `
                                    <div class="border-top pt-2">
                                        <small class="text-muted">${analysis.overall_verdict}</small>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            analysisHtml += `
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Summary Statistics
        analysisHtml += `
            <div class="alert alert-info mt-3">
                <h6><i class="fas fa-chart-bar me-2"></i>Analysis Summary</h6>
                <p class="mb-0">
                    Analyzed <strong>${data.analyzed_repos || 0}</strong> out of <strong>${data.total_repos || 0}</strong> repositories.
                    ${data.overall_assessment ? `Overall recommendation: <strong>${data.overall_assessment.hiring_recommendation || 'Not specified'}</strong>` : ''}
                </p>
            </div>
        `;
        
        analysisContentDiv.innerHTML = analysisHtml;
    }
    
    // Helper functions for styling
    function getSkillLevelColor(level) {
        switch(level?.toLowerCase()) {
            case 'junior': return 'primary';
            case 'mid': return 'info';
            case 'senior': return 'success';
            case 'lead': return 'warning';
            case 'architect': return 'danger';
            default: return 'secondary';
        }
    }
    
    function getRatingColor(rating) {
        switch(rating?.toLowerCase()) {
            case 'novice': return 'light';
            case 'intermediate': return 'primary';
            case 'advanced': return 'success';
            case 'expert': return 'warning';
            default: return 'secondary';
        }
    }
    
    function getQualityColor(quality) {
        switch(quality?.toLowerCase()) {
            case 'poor': return 'danger';
            case 'fair': return 'warning';
            case 'good': return 'success';
            case 'excellent': return 'primary';
            default: return 'secondary';
        }
    }
    
    function getHiringRecommendationColor(recommendation) {
        switch(recommendation?.toLowerCase()) {
            case 'avoid': return 'danger';
            case 'consider': return 'warning';
            case 'recommend': return 'success';
            case 'strongly_recommend': return 'primary';
            default: return 'secondary';
        }
    }
    
    function getScoreColor(score) {
        if (score >= 80) return 'success';
        if (score >= 60) return 'info';
        if (score >= 40) return 'warning';
        return 'danger';
    }
</script>
{% endblock %}
